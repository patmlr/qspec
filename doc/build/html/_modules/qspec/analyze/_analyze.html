<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>qspec.analyze._analyze &mdash; qspec 30.05.2024 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" href="../../../_static/css/borders.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/wy-nav-content.css" type="text/css" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js?v=861d89a9"></script>
        <script src="../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            qspec
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">qspec</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">qspec</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">qspec.analyze._analyze</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for qspec.analyze._analyze</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">qspec._analyze</span>
<span class="sd">==============</span>

<span class="sd">Module for analyzing/evaluating/fitting data.</span>

<span class="sd">Linear regression algorithms (2d):</span>
<span class="sd">    - york_fit(); [York et al., Am. J. Phys. 72, 367 (2004)]</span>
<span class="sd">    - linear_fit(); 2-dimensional maximum likelihood fit.</span>
<span class="sd">    - linear_monte_carlo(); based on [Gebert et al., Phys. Rev. Lett. 115, 053003 (2015), Suppl.]</span>
<span class="sd">    </span>
<span class="sd">Linear regression algorithms (nd):</span>
<span class="sd">    - linear_nd_fit(); n-dimensional maximum likelihood fit.</span>
<span class="sd">    - linear_monte_carlo_nd(); based on [Gebert et al., Phys. Rev. Lett. 115, 053003 (2015), Suppl.]</span>

<span class="sd">Curve fitting methods:</span>
<span class="sd">    - curve_fit(); Reimplements the scipy.optimize.curve_fit method to allow fixing parameters</span>
<span class="sd">      and having parameter-dependent y-uncertainties.</span>
<span class="sd">    - odr_fit(); Encapsulates the scipy.odr.odr method to accept inputs similarly to curve_fit().</span>

<span class="sd">Classes:</span>
<span class="sd">    - King; Creates a King plot with isotope shifts or nuclear charge radii.</span>

<span class="sd">LICENSE NOTES:</span>
<span class="sd">    The method curve_fit is a modified version of scipy.optimize.curve_fit.</span>
<span class="sd">    Therefore, it is licensed under the &#39;BSD 3-Clause &quot;New&quot; or &quot;Revised&quot; License&#39; provided with scipy.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.optimize._minpack_py</span> <span class="kn">import</span> <span class="n">Bounds</span><span class="p">,</span> <span class="n">LinAlgError</span><span class="p">,</span> <span class="n">OptimizeWarning</span><span class="p">,</span> <span class="n">_getfullargspec</span><span class="p">,</span> <span class="n">_initialize_feasible</span><span class="p">,</span> \
    <span class="n">_wrap_jac</span><span class="p">,</span> <span class="n">cholesky</span><span class="p">,</span> <span class="n">least_squares</span><span class="p">,</span> <span class="n">leastsq</span><span class="p">,</span> <span class="n">prepare_bounds</span><span class="p">,</span> <span class="n">solve_triangular</span><span class="p">,</span> <span class="n">svd</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">norm</span><span class="p">,</span> <span class="n">multivariate_normal</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">odr</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">qspec._types</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">qspec</span> <span class="kn">import</span> <span class="n">tools</span>
<span class="kn">from</span> <span class="nn">qspec.physics</span> <span class="kn">import</span> <span class="n">me_u</span><span class="p">,</span> <span class="n">me_u_d</span>
<span class="kn">from</span> <span class="nn">qspec.analyze._analyze_cpp</span> <span class="kn">import</span> <span class="n">generate_collinear_points_cpp</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;poly&#39;</span><span class="p">,</span> <span class="s1">&#39;const&#39;</span><span class="p">,</span> <span class="s1">&#39;straight&#39;</span><span class="p">,</span> <span class="s1">&#39;straight_direction&#39;</span><span class="p">,</span> <span class="s1">&#39;straight_std&#39;</span><span class="p">,</span> <span class="s1">&#39;straight_x_std&#39;</span><span class="p">,</span>
           <span class="s1">&#39;draw_straight_unc_area&#39;</span><span class="p">,</span> <span class="s1">&#39;ellipse2d&#39;</span><span class="p">,</span> <span class="s1">&#39;draw_sigma2d&#39;</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="s1">&#39;york_fit&#39;</span><span class="p">,</span> <span class="s1">&#39;linear_nd_fit&#39;</span><span class="p">,</span> <span class="s1">&#39;linear_fit&#39;</span><span class="p">,</span>
           <span class="s1">&#39;generate_collinear_points_py&#39;</span><span class="p">,</span> <span class="s1">&#39;linear_nd_monte_carlo&#39;</span><span class="p">,</span> <span class="s1">&#39;linear_monte_carlo&#39;</span><span class="p">,</span> <span class="s1">&#39;linear_alpha_fit&#39;</span><span class="p">,</span>
           <span class="s1">&#39;odr_fit&#39;</span><span class="p">,</span> <span class="s1">&#39;curve_fit&#39;</span><span class="p">,</span> <span class="s1">&#39;King&#39;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_wrap_func_pars</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p0_fixed</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">func_wrapped</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">):</span>
        <span class="n">_params</span> <span class="o">=</span> <span class="n">p0</span>
        <span class="n">_params</span><span class="p">[</span><span class="o">~</span><span class="n">p0_fixed</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">_params</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">func_wrapped</span>


<span class="k">def</span> <span class="nf">_wrap_func_sigma</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p0_fixed</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">yfunc</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">):</span>
        <span class="n">_params</span> <span class="o">=</span> <span class="n">p0</span>
        <span class="n">_params</span><span class="p">[</span><span class="o">~</span><span class="n">p0_fixed</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">sigma</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">yfunc</span><span class="p">,</span> <span class="o">*</span><span class="n">_params</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">transform</span>


<span class="k">def</span> <span class="nf">_wrap_func</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">transform</span><span class="p">):</span>
    <span class="c1"># Copied from scipy, extended for callables.</span>
    <span class="k">if</span> <span class="n">transform</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">func_wrapped</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span> <span class="o">-</span> <span class="n">ydata</span>
    <span class="k">elif</span> <span class="nb">callable</span><span class="p">(</span><span class="n">transform</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">func_wrapped</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
            <span class="n">yfunc</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">transform</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">yfunc</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">yfunc</span> <span class="o">-</span> <span class="n">ydata</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">transform</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">func_wrapped</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span> <span class="o">-</span> <span class="n">ydata</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">func_wrapped</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">solve_triangular</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="n">func</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span> <span class="o">-</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">func_wrapped</span>


<div class="viewcode-block" id="poly"><a class="viewcode-back" href="../../../qspec.html#qspec.analyze.poly">[docs]</a><span class="k">def</span> <span class="nf">poly</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param x: The x values.</span>
<span class="sd">    :param args: The coefficients of the polynomial.</span>
<span class="sd">    :returns: args[0] + args[1] * x + args[2] / 2 * x ** 2 + args[3] / 6 * x ** 3 + ...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">args</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">/</span> <span class="n">tools</span><span class="o">.</span><span class="n">factorial</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span> <span class="o">**</span> <span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">))],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="const"><a class="viewcode-back" href="../../../qspec.html#qspec.analyze.const">[docs]</a><span class="k">def</span> <span class="nf">const</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">array_like</span><span class="p">,</span> <span class="n">a</span><span class="p">:</span> <span class="n">array_like</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param x: The x values.</span>
<span class="sd">    :param a: The y-intercept.</span>
<span class="sd">    :returns: A constant function with value &#39;a&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span></div>


<div class="viewcode-block" id="straight"><a class="viewcode-back" href="../../../qspec.html#qspec.analyze.straight">[docs]</a><span class="k">def</span> <span class="nf">straight</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">array_like</span><span class="p">,</span> <span class="n">a</span><span class="p">:</span> <span class="n">array_like</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">array_like</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param x: The x values.</span>
<span class="sd">    :param a: The y-intercept.</span>
<span class="sd">    :param b: The slope.</span>
<span class="sd">    :returns: The y values resulting from the &#39;x&#39; values via the given linear relation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">x</span></div>


<div class="viewcode-block" id="straight_direction"><a class="viewcode-back" href="../../../qspec.html#qspec.analyze.straight_direction">[docs]</a><span class="k">def</span> <span class="nf">straight_direction</span><span class="p">(</span><span class="n">p_0</span><span class="p">:</span> <span class="n">array_iter</span><span class="p">,</span> <span class="n">p_1</span><span class="p">:</span> <span class="n">array_iter</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param p_0: The first point(s).</span>
<span class="sd">    :param p_1: The second point(s).</span>
<span class="sd">    :param axis: The axis along which the vector components are aligned.</span>
<span class="sd">    :returns: The direction of a straight line in n dimensions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p_0</span><span class="p">,</span> <span class="n">p_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">p_0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">p_1</span><span class="p">)</span>
    <span class="n">dr</span> <span class="o">=</span> <span class="n">p_1</span> <span class="o">-</span> <span class="n">p_0</span>
    <span class="k">return</span> <span class="n">dr</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">tools</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">dr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span></div>


<div class="viewcode-block" id="straight_std"><a class="viewcode-back" href="../../../qspec.html#qspec.analyze.straight_std">[docs]</a><span class="k">def</span> <span class="nf">straight_std</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">array_like</span><span class="p">,</span> <span class="n">sigma_a</span><span class="p">:</span> <span class="n">array_like</span><span class="p">,</span> <span class="n">sigma_b</span><span class="p">:</span> <span class="n">array_like</span><span class="p">,</span> <span class="n">corr_ab</span><span class="p">:</span> <span class="n">array_like</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param x: The x values.</span>
<span class="sd">    :param sigma_a: The standard deviation of the y-intercept.</span>
<span class="sd">    :param sigma_b: The standard deviation of the slope.</span>
<span class="sd">    :param corr_ab: The correlation coefficient between the slope and y-intercept.</span>
<span class="sd">    :returns: The standard deviation of a straight line where the x values do not have uncertainties.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">sigma_a</span><span class="p">,</span> <span class="n">sigma_b</span><span class="p">,</span> <span class="n">corr_ab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sigma_a</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sigma_b</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">corr_ab</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sigma_a</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">sigma_b</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">sigma_a</span> <span class="o">*</span> <span class="n">sigma_b</span> <span class="o">*</span> <span class="n">corr_ab</span><span class="p">)</span></div>


<div class="viewcode-block" id="straight_x_std"><a class="viewcode-back" href="../../../qspec.html#qspec.analyze.straight_x_std">[docs]</a><span class="k">def</span> <span class="nf">straight_x_std</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">array_like</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">array_like</span><span class="p">,</span> <span class="n">sigma_x</span><span class="p">:</span> <span class="n">array_like</span><span class="p">,</span>
                   <span class="n">sigma_a</span><span class="p">:</span> <span class="n">array_like</span><span class="p">,</span> <span class="n">sigma_b</span><span class="p">:</span> <span class="n">array_like</span><span class="p">,</span> <span class="n">corr_ab</span><span class="p">:</span> <span class="n">array_like</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param x: The x values.</span>
<span class="sd">    :param b: The slope.</span>
<span class="sd">    :param sigma_x: The standard deviation of the x values.</span>
<span class="sd">    :param sigma_a: The standard deviation of the y-intercept.</span>
<span class="sd">    :param sigma_b: The standard deviation of the slope.</span>
<span class="sd">    :param corr_ab: The correlation coefficient between the slope and y-intercept.</span>
<span class="sd">    :returns: The standard deviation of a straight line where all input values have uncertainties.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">sigma_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sigma_x</span><span class="p">)</span>
    <span class="n">b</span><span class="p">,</span> <span class="n">sigma_a</span><span class="p">,</span> <span class="n">sigma_b</span><span class="p">,</span> <span class="n">corr_ab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sigma_a</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sigma_b</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">corr_ab</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sigma_a</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">sigma_b</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">sigma_a</span> <span class="o">*</span> <span class="n">sigma_b</span> <span class="o">*</span> <span class="n">corr_ab</span>
                   <span class="o">+</span> <span class="p">(</span><span class="n">b</span> <span class="o">*</span> <span class="n">sigma_x</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">sigma_b</span> <span class="o">*</span> <span class="n">sigma_x</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="draw_straight_unc_area"><a class="viewcode-back" href="../../../qspec.html#qspec.analyze.draw_straight_unc_area">[docs]</a><span class="k">def</span> <span class="nf">draw_straight_unc_area</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">array_like</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">array_like</span><span class="p">,</span> <span class="n">sigma_a</span><span class="p">:</span> <span class="n">array_like</span><span class="p">,</span> <span class="n">sigma_b</span><span class="p">:</span> <span class="n">array_like</span><span class="p">,</span>
                           <span class="n">corr_ab</span><span class="p">:</span> <span class="n">array_like</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param x: The x values.</span>
<span class="sd">    :param y: The y values.</span>
<span class="sd">    :param sigma_a: The standard deviation of the y-intercept.</span>
<span class="sd">    :param sigma_b: The standard deviation of the slope.</span>
<span class="sd">    :param corr_ab: The correlation coefficient between the slope and y-intercept.</span>
<span class="sd">    :param kwargs: The keyword arguments for the fill_between function.</span>
<span class="sd">    :returns: The standard deviation of a straight line where the x values do not have uncertainties.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">unc</span> <span class="o">=</span> <span class="n">straight_std</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">sigma_a</span><span class="p">,</span> <span class="n">sigma_b</span><span class="p">,</span> <span class="n">corr_ab</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">unc</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">unc</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="ellipse2d"><a class="viewcode-back" href="../../../qspec.html#qspec.analyze.ellipse2d">[docs]</a><span class="k">def</span> <span class="nf">ellipse2d</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">array_like</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">array_like</span><span class="p">,</span> <span class="n">scale_x</span><span class="p">:</span> <span class="n">array_like</span><span class="p">,</span> <span class="n">scale_y</span><span class="p">:</span> <span class="n">array_like</span><span class="p">,</span>
              <span class="n">phi</span><span class="p">:</span> <span class="n">array_like</span><span class="p">,</span> <span class="n">corr</span><span class="p">:</span> <span class="n">array_like</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">ndarray</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param x: The x-component of the position of the ellipse.</span>
<span class="sd">    :param y: The y-component of the position of the ellipse.</span>
<span class="sd">    :param scale_x: The amplitude of the x-component.</span>
<span class="sd">    :param scale_y: The amplitude of the y-component.</span>
<span class="sd">    :param phi: The angle between the vector to the point on the ellipse and the x-axis.</span>
<span class="sd">    :param corr: The correlation coefficient between the x and y data.</span>
<span class="sd">    :returns: A point on an ellipse in 2d-space with amplitudes &#39;x&#39;, &#39;y&#39;</span>
<span class="sd">     and correlation &#39;corr&#39; between x- and y-component.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">scale_x</span><span class="p">,</span> <span class="n">scale_y</span><span class="p">,</span> <span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> \
        <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">scale_x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">scale_y</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">corr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">scale_x</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">y</span> <span class="o">+</span> <span class="n">scale_y</span> <span class="o">*</span> <span class="p">(</span><span class="n">corr</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">corr</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">))</span></div>


<div class="viewcode-block" id="draw_sigma2d"><a class="viewcode-back" href="../../../qspec.html#qspec.analyze.draw_sigma2d">[docs]</a><span class="k">def</span> <span class="nf">draw_sigma2d</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">array_iter</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">array_iter</span><span class="p">,</span> <span class="n">sigma_x</span><span class="p">:</span> <span class="n">array_iter</span><span class="p">,</span> <span class="n">sigma_y</span><span class="p">:</span> <span class="n">array_iter</span><span class="p">,</span>
                 <span class="n">corr</span><span class="p">:</span> <span class="n">array_iter</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param x: The x data.</span>
<span class="sd">    :param y: The y data.</span>
<span class="sd">    :param sigma_x: The 1-sigma uncertainties of the x data.</span>
<span class="sd">    :param sigma_y: The 1-sigma uncertainties of the y data.</span>
<span class="sd">    :param corr: The correlation coefficients between the x and y data.</span>
<span class="sd">    :param n: The maximum sigma region to draw</span>
<span class="sd">    :param kwargs: Additional keyword arguments are passed to plt.plot().</span>
<span class="sd">     Use key &#39;fmt&#39; to specify the third argument of plt.plot().</span>
<span class="sd">    :returns: None. Draws the sigma-bounds of the given data points (x, y) until the n-sigma region.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;-k&#39;</span>
    <span class="k">if</span> <span class="s1">&#39;fmt&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;fmt&#39;</span><span class="p">)</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">361</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">x_i</span><span class="p">,</span> <span class="n">y_i</span><span class="p">,</span> <span class="n">s_x</span><span class="p">,</span> <span class="n">s_y</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sigma_x</span><span class="p">,</span> <span class="n">sigma_y</span><span class="p">,</span> <span class="n">corr</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="n">ellipse2d</span><span class="p">(</span><span class="n">x_i</span><span class="p">,</span> <span class="n">y_i</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="n">s_x</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="n">s_y</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">r</span><span class="p">),</span> <span class="n">fmt</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="weight"><a class="viewcode-back" href="../../../qspec.html#qspec.analyze.weight">[docs]</a><span class="k">def</span> <span class="nf">weight</span><span class="p">(</span><span class="n">sigma</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param sigma: The 1-sigma uncertainty.</span>
<span class="sd">    :returns: The weight corresponding to the 1-sigma uncertainty &#39;sigma&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">sigma</span> <span class="o">**</span> <span class="mi">2</span></div>


<div class="viewcode-block" id="york_fit"><a class="viewcode-back" href="../../../qspec.html#qspec.analyze.york_fit">[docs]</a><span class="k">def</span> <span class="nf">york_fit</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">array_iter</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">array_iter</span><span class="p">,</span> <span class="n">sigma_x</span><span class="p">:</span> <span class="n">array_iter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sigma_y</span><span class="p">:</span> <span class="n">array_iter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">corr</span><span class="p">:</span> <span class="n">array_iter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">iter_max</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span> <span class="n">report</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">show</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A linear regression algorithm to find the best straight line, given normally distributed errors for x and y</span>
<span class="sd">    and correlation coefficients between errors in x and y. The algorithm is described in</span>
<span class="sd">    [&#39;Unified equations for the slope, intercept, and standard errors of the best straight line&#39;,</span>
<span class="sd">    York et al., American Journal of Physics 72, 367 (2004)]. See the comments to compare the individual steps.</span>

<span class="sd">    :param x: The x data.</span>
<span class="sd">    :param y: The y data.</span>
<span class="sd">    :param sigma_x: The 1-sigma uncertainties of the x data.</span>
<span class="sd">    :param sigma_y: The 1-sigma uncertainties of the y data.</span>
<span class="sd">    :param corr: The correlation coefficients between the x and y data.</span>
<span class="sd">    :param iter_max: The maximum number of iterations to find the best slope.</span>
<span class="sd">    :param report: Whether to print the result of the fit.</span>
<span class="sd">    :param show: Whether to plot the fit result.</span>
<span class="sd">    :returns: popt, pcov. The best y-intercept and slope, their covariance matrix and the used alpha.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sigma_x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sigma_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">report</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">No uncertainties for </span><span class="se">\&#39;</span><span class="s1">x</span><span class="se">\&#39;</span><span class="s1"> were given. Assuming </span><span class="se">\&#39;</span><span class="s1">sigma_x</span><span class="se">\&#39;</span><span class="s1">=1.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sigma_y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sigma_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">report</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">No uncertainties for </span><span class="se">\&#39;</span><span class="s1">y</span><span class="se">\&#39;</span><span class="s1"> were given. Assuming </span><span class="se">\&#39;</span><span class="s1">sigma_y</span><span class="se">\&#39;</span><span class="s1">=1.&#39;</span><span class="p">)</span>
    <span class="n">sigma_2d</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">corr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sigma_2d</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">corr</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="n">sigma_x</span><span class="p">,</span> <span class="n">sigma_y</span><span class="p">,</span> <span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sigma_x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sigma_y</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">corr</span><span class="p">)</span>

    <span class="n">p_opt</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">straight</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma_y</span><span class="p">)</span>  <span class="c1"># (1)</span>
    <span class="n">b_init</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">b_init</span>

    <span class="n">w_x</span><span class="p">,</span> <span class="n">w_y</span> <span class="o">=</span> <span class="n">weight</span><span class="p">(</span><span class="n">sigma_x</span><span class="p">),</span> <span class="n">weight</span><span class="p">(</span><span class="n">sigma_y</span><span class="p">)</span>  <span class="c1"># w(X_i), w(Y_i), (2)</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">w_x</span> <span class="o">*</span> <span class="n">w_y</span><span class="p">)</span>

    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">r_tol</span> <span class="o">=</span> <span class="mf">1e-15</span>
    <span class="n">tol</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="n">mod_w</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">x_bar</span><span class="p">,</span> <span class="n">y_bar</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">while</span> <span class="n">tol</span> <span class="o">&gt;</span> <span class="n">r_tol</span> <span class="ow">and</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">iter_max</span><span class="p">:</span>  <span class="c1"># (6)</span>
        <span class="n">b_init</span> <span class="o">=</span> <span class="n">b</span>
        <span class="n">mod_w</span> <span class="o">=</span> <span class="n">w_x</span> <span class="o">*</span> <span class="n">w_y</span> <span class="o">/</span> <span class="p">(</span><span class="n">w_x</span> <span class="o">+</span> <span class="n">b_init</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">w_y</span> <span class="o">-</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">b_init</span> <span class="o">*</span> <span class="n">corr</span> <span class="o">*</span> <span class="n">alpha</span><span class="p">)</span>  <span class="c1"># W_i, (3)</span>
        <span class="n">x_bar</span><span class="p">,</span> <span class="n">y_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">mod_w</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">mod_w</span><span class="p">)</span>  <span class="c1"># (4)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">x_bar</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">y_bar</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">mod_w</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">/</span> <span class="n">w_y</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">b_init</span> <span class="o">/</span> <span class="n">w_x</span> <span class="o">-</span> <span class="n">straight</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">b_init</span><span class="p">)</span> <span class="o">*</span> <span class="n">corr</span> <span class="o">/</span> <span class="n">alpha</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mod_w</span> <span class="o">*</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">v</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mod_w</span> <span class="o">*</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">u</span><span class="p">)</span>  <span class="c1"># (5)</span>
        <span class="n">tol</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">b</span> <span class="o">-</span> <span class="n">b_init</span><span class="p">)</span> <span class="o">/</span> <span class="n">b</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># (6)</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">y_bar</span> <span class="o">-</span> <span class="n">b</span> <span class="o">*</span> <span class="n">x_bar</span>  <span class="c1"># (7)</span>
    <span class="n">x_i</span> <span class="o">=</span> <span class="n">x_bar</span> <span class="o">+</span> <span class="n">beta</span>  <span class="c1"># (8)</span>
    <span class="n">x_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x_i</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">mod_w</span><span class="p">)</span>  <span class="c1"># (9)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">x_i</span> <span class="o">-</span> <span class="n">x_bar</span>
    <span class="n">sigma_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mod_w</span> <span class="o">*</span> <span class="n">u</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>  <span class="c1"># (10)</span>
    <span class="n">sigma_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mod_w</span><span class="p">)</span> <span class="o">+</span> <span class="n">x_bar</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">sigma_b</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">corr_ab</span> <span class="o">=</span> <span class="o">-</span><span class="n">x_bar</span> <span class="o">*</span> <span class="n">sigma_b</span> <span class="o">/</span> <span class="n">sigma_a</span>
    <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mod_w</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">b</span> <span class="o">*</span> <span class="n">x</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">report</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="n">iter_max</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Maximum number of iterations (</span><span class="si">{}</span><span class="s1">) was reached.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iter_max</span><span class="p">))</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">printh</span><span class="p">(</span><span class="s1">&#39;york_fit result:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;a: </span><span class="si">{}</span><span class="s1"> +/- </span><span class="si">{}</span><span class="se">\n</span><span class="s1">b: </span><span class="si">{}</span><span class="s1"> +/- </span><span class="si">{}</span><span class="se">\n</span><span class="s1">corr_ab: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">red. chi2: </span><span class="si">{}</span><span class="s1">&#39;</span>
              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">sigma_a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">sigma_b</span><span class="p">,</span> <span class="n">corr_ab</span><span class="p">,</span> <span class="n">chi2</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">x_cont</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="mi">1001</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sigma_2d</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;k.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data&#39;</span><span class="p">)</span>
            <span class="n">draw_sigma2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sigma_x</span><span class="p">,</span> <span class="n">sigma_y</span><span class="p">,</span> <span class="n">corr</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xerr</span><span class="o">=</span><span class="n">sigma_x</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">sigma_y</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;k.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_cont</span><span class="p">,</span> <span class="n">straight</span><span class="p">(</span><span class="n">x_cont</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Fit&#39;</span><span class="p">)</span>
        <span class="n">y_min</span> <span class="o">=</span> <span class="n">straight</span><span class="p">(</span><span class="n">x_cont</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="n">straight_std</span><span class="p">(</span><span class="n">x_cont</span><span class="p">,</span> <span class="n">sigma_a</span><span class="p">,</span> <span class="n">sigma_b</span><span class="p">,</span> <span class="n">corr_ab</span><span class="p">)</span>
        <span class="n">y_max</span> <span class="o">=</span> <span class="n">straight</span><span class="p">(</span><span class="n">x_cont</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="n">straight_std</span><span class="p">(</span><span class="n">x_cont</span><span class="p">,</span> <span class="n">sigma_a</span><span class="p">,</span> <span class="n">sigma_b</span><span class="p">,</span> <span class="n">corr_ab</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x_cont</span><span class="p">,</span> <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">antialiased</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">numpoints</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="n">popt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">pcov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">sigma_a</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sigma_a</span> <span class="o">*</span> <span class="n">sigma_b</span> <span class="o">*</span> <span class="n">corr_ab</span><span class="p">],</span>
                     <span class="p">[</span><span class="n">sigma_a</span> <span class="o">*</span> <span class="n">sigma_b</span> <span class="o">*</span> <span class="n">corr_ab</span><span class="p">,</span> <span class="n">sigma_b</span> <span class="o">**</span> <span class="mi">2</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span></div>


<span class="k">def</span> <span class="nf">covariance_matrix</span><span class="p">(</span><span class="n">cov</span><span class="p">:</span> <span class="n">array_iter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sigma</span><span class="p">:</span> <span class="n">array_iter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">corr</span><span class="p">:</span> <span class="n">array_iter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param cov: The covariance matrices. Must have shape (k, n, n), where k is the number of data points</span>
<span class="sd">     and n the number of dimensions of each data point. If None, the other parameters are used.</span>
<span class="sd">     If not None, all other parameters are ignored.</span>
<span class="sd">    :param sigma: The standard deviations of the data vectors. Must have shape (k, n).</span>
<span class="sd">     If None, all diagonal elements of the covariance matrix are 1.</span>
<span class="sd">    :param corr: The correlation matrices of the data vectors. Must have shape (k, n, n).</span>
<span class="sd">     If n == 2 it can have shape (k, ). If None, all off-diagonal elements of the covariance matrix are 0.</span>
<span class="sd">    :param k: The number of data points. It is omitted if &#39;sigma&#39; or &#39;corr&#39; is specified.</span>
<span class="sd">    :param n: The number of dimensions of each data point. It is omitted if &#39;sigma&#39; or &#39;corr&#39; is specified.</span>
<span class="sd">    :returns: A covariance matrix constructed from &#39;sigma&#39; and &#39;corr&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cov</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">asarray_optional</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">sigma</span><span class="p">,</span> <span class="n">corr</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">asarray_optional</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span> <span class="n">tools</span><span class="o">.</span><span class="n">asarray_optional</span><span class="p">(</span><span class="n">corr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cov</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="k">if</span> <span class="n">sigma</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">corr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">sigma</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">corr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">corr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">corr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[[</span><span class="mi">1</span><span class="p">,</span> <span class="n">corr</span><span class="p">[</span><span class="n">_k</span><span class="p">]],</span> <span class="p">[</span><span class="n">corr</span><span class="p">[</span><span class="n">_k</span><span class="p">],</span> <span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">_k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">corr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">sigma</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">corr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">k</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">sigma</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">k</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">sigma</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">corr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[[</span><span class="mi">1</span><span class="p">,</span> <span class="n">corr</span><span class="p">[</span><span class="n">_k</span><span class="p">]],</span> <span class="p">[</span><span class="n">corr</span><span class="p">[</span><span class="n">_k</span><span class="p">],</span> <span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">_k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="n">cov</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">corr</span>

    <span class="k">return</span> <span class="n">cov</span>


<span class="k">def</span> <span class="nf">_x0_r_from_p</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="n">dim</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">p</span><span class="p">[:</span><span class="n">dim</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="n">dim</span><span class="p">:]</span>


<span class="k">def</span> <span class="nf">_linear_nd_t0</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">cov_inv</span><span class="p">):</span>
    <span class="n">x0</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">_x0_r_from_p</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">xi</span> <span class="o">=</span> <span class="n">x0</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">x</span>  <span class="c1"># (size, dim)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cov_inv</span> <span class="o">*</span> <span class="n">r</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (size, dim)</span>

    <span class="n">var_t</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">ax</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (size, )</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">var_t</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xi</span> <span class="o">*</span> <span class="n">ax</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (size, )</span>


<span class="k">def</span> <span class="nf">_linear_nd_func</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">cov_inv</span><span class="p">):</span>
    <span class="n">x0</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">_x0_r_from_p</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>  <span class="c1"># (dim, ), (dim, )</span>
    <span class="n">xi</span> <span class="o">=</span> <span class="n">x0</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">x</span>  <span class="c1"># (size, dim)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cov_inv</span> <span class="o">*</span> <span class="n">r</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (size, dim)</span>
    <span class="n">ar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cov_inv</span> <span class="o">*</span> <span class="n">xi</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (size, dim)</span>

    <span class="n">var_t</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">ax</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (size, )</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="o">-</span><span class="n">var_t</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xi</span> <span class="o">*</span> <span class="n">ax</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (size, )</span>
    <span class="n">tx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xi</span> <span class="o">*</span> <span class="n">ar</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (size, )</span>
    <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">tx</span> <span class="o">-</span> <span class="n">t0</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">var_t</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># ()</span>


<span class="k">def</span> <span class="nf">_linear_nd_jac</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">cov_inv</span><span class="p">):</span>
    <span class="n">x0</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">_x0_r_from_p</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>  <span class="c1"># (dim, ), (dim, )</span>
    <span class="n">xi</span> <span class="o">=</span> <span class="n">x0</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">x</span>  <span class="c1"># (size, dim)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cov_inv</span> <span class="o">*</span> <span class="n">r</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># = da/dx = 0.5 * db/dr, (size, dim)</span>
    <span class="n">ar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cov_inv</span> <span class="o">*</span> <span class="n">xi</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># = da/dr, (size, dim)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xi</span> <span class="o">*</span> <span class="n">ax</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>  <span class="c1"># (size, 1)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">ax</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>  <span class="c1"># (size, 1)</span>

    <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ar</span> <span class="o">-</span> <span class="n">a</span> <span class="o">/</span> <span class="n">b</span> <span class="o">*</span> <span class="n">ax</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># (dim, )</span>
    <span class="n">rr</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">a</span> <span class="o">/</span> <span class="n">b</span> <span class="o">*</span> <span class="n">ar</span> <span class="o">-</span> <span class="n">a</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">b</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ax</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># (dim, )</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">xx</span><span class="p">,</span> <span class="n">rr</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># (2 * dim, )</span>


<span class="k">def</span> <span class="nf">_linear_nd_hess</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">cov_inv</span><span class="p">):</span>
    <span class="n">x0</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">_x0_r_from_p</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>  <span class="c1"># (dim, ), (dim, )</span>
    <span class="n">xi</span> <span class="o">=</span> <span class="n">x0</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">x</span>  <span class="c1"># (size, dim)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cov_inv</span> <span class="o">*</span> <span class="n">r</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># = da/dx, (size, dim)</span>
    <span class="n">ar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cov_inv</span> <span class="o">*</span> <span class="n">xi</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># = da/dr, (size, dim)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xi</span> <span class="o">*</span> <span class="n">ax</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>  <span class="c1"># (size, 1, 1)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">ax</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>  <span class="c1"># (size, 1, 1)</span>

    <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cov_inv</span> <span class="o">-</span> <span class="n">ax</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">ax</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">b</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># (dim, dim)</span>
    <span class="n">rr</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">ar</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">/</span> <span class="n">b</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">a</span> <span class="o">/</span> <span class="n">b</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ax</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">])</span> <span class="o">*</span> <span class="n">ar</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
                 <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">b</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">ax</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="n">a</span> <span class="o">/</span> <span class="n">b</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ar</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">])</span> <span class="o">*</span> <span class="n">ax</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
                 <span class="o">-</span> <span class="n">a</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">b</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">cov_inv</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># (dim, dim)</span>
    <span class="n">xr</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">ar</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">/</span> <span class="n">b</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">a</span> <span class="o">/</span> <span class="n">b</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ax</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">])</span> <span class="o">*</span> <span class="n">ax</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
                 <span class="o">+</span> <span class="n">a</span> <span class="o">/</span> <span class="n">b</span> <span class="o">*</span> <span class="n">cov_inv</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># (dim, dim)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">block</span><span class="p">([[</span><span class="n">xx</span><span class="p">,</span> <span class="n">xr</span><span class="p">],</span> <span class="p">[</span><span class="n">xr</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">rr</span><span class="p">]])</span>  <span class="c1"># (2 * dim, 2 * dim)</span>


<span class="k">def</span> <span class="nf">_get_linear_nd_reduced</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cov_inv</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;_linear_nd_</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">dim</span> <span class="o">=</span> <span class="n">p0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;jac&#39;</span><span class="p">:</span> <span class="n">mask</span><span class="p">,</span> <span class="s1">&#39;hess&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">mask</span><span class="p">)}[</span><span class="n">method</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="n">_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">[</span><span class="n">axis</span><span class="p">,</span> <span class="n">axis</span> <span class="o">+</span> <span class="n">dim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">p0</span><span class="p">[</span><span class="n">axis</span><span class="p">],</span> <span class="n">p0</span><span class="p">[</span><span class="n">axis</span> <span class="o">+</span> <span class="n">dim</span><span class="p">]])</span>
        <span class="k">return</span> <span class="n">m</span><span class="p">(</span><span class="n">_p</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">cov_inv</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">m</span><span class="p">(</span><span class="n">_p</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">cov_inv</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">func</span>


<div class="viewcode-block" id="linear_nd_fit"><a class="viewcode-back" href="../../../qspec.html#qspec.analyze.linear_nd_fit">[docs]</a><span class="k">def</span> <span class="nf">linear_nd_fit</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">array_iter</span><span class="p">,</span> <span class="n">cov</span><span class="p">:</span> <span class="n">array_iter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">p0</span><span class="p">:</span> <span class="n">array_iter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">optimize_cov</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param x: The data vectors. Must have shape (k, n), where k is the number of data points</span>
<span class="sd">     and n is the number of dimensions of each point.</span>
<span class="sd">    :param cov: The covariance matrices of the data vectors. Must have shape (k, n, n).</span>
<span class="sd">     Use &#39;covariance_matrix&#39; to construct covariance matrices.</span>
<span class="sd">    :param p0: The start parameters for the linear fit. Must have shape (2n, ).</span>
<span class="sd">     The first n elements specify the origin vector of the straight,</span>
<span class="sd">     the second n elements specify the direction of the straight.</span>
<span class="sd">    :param axis: The component of the n-dimensional vectors which are fixed for fitting.</span>
<span class="sd">     This is required since a straight in n dimensions is fully described by 2 (n - 1) parameters.</span>
<span class="sd">     If None, the best axis is determined from the data and the direction vector of the straight is normalized.</span>
<span class="sd">    :param optimize_cov: If True, the origin vector of the straight is optimized to yield the smallest covariances.</span>
<span class="sd">    :param kwargs: Additional keyword arguments.</span>
<span class="sd">    :returns: popt, pcov. The optimized parameters and their covariances. The resulting shapes are (2n, ) and (2n, 2n).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">size</span><span class="p">,</span> <span class="n">dim</span> <span class="o">=</span> <span class="n">x_temp</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">axis_was_none</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axis_was_none</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">x_temp</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x_temp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">axis</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">axis</span> <span class="o">+=</span> <span class="n">dim</span>

    <span class="n">cov</span> <span class="o">=</span> <span class="n">covariance_matrix</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">dim</span><span class="p">)</span>

    <span class="n">x_off</span> <span class="o">=</span> <span class="n">x_temp</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">x_temp</span><span class="p">[:,</span> <span class="n">axis</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">x_temp</span> <span class="o">-=</span> <span class="n">x_off</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">i_fac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x_temp</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">x_fac</span> <span class="o">=</span> <span class="n">x_temp</span><span class="p">[</span><span class="n">i_fac</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dim</span><span class="p">)]</span>
    <span class="c1"># x_fac = np.max(np.abs(x_temp), axis=0)</span>
    <span class="n">x_temp</span> <span class="o">/=</span> <span class="n">x_fac</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">cov_temp</span> <span class="o">=</span> <span class="n">cov</span> <span class="o">/</span> <span class="p">(</span><span class="n">x_fac</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">x_fac</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">])</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">cov_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cov_temp</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unable to invert covariance matrix (&quot;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&quot;)&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">p0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">popt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">popt</span><span class="p">[</span><span class="n">dim</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">popt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">check_dimension</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dim</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">popt</span><span class="p">)</span>
        <span class="n">popt</span><span class="p">[:</span><span class="n">dim</span><span class="p">]</span> <span class="o">-=</span> <span class="n">x_off</span>
        <span class="n">popt</span><span class="p">[:</span><span class="n">dim</span><span class="p">]</span> <span class="o">/=</span> <span class="n">x_fac</span>
        <span class="n">popt</span><span class="p">[</span><span class="n">dim</span><span class="p">:]</span> <span class="o">/=</span> <span class="n">x_fac</span> <span class="o">/</span> <span class="n">x_fac</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span>

    <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">i</span> <span class="o">==</span> <span class="n">axis</span>
    <span class="n">mask</span> <span class="o">+=</span> <span class="n">i</span> <span class="o">==</span> <span class="n">dim</span> <span class="o">+</span> <span class="n">axis</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">mask</span>
    <span class="n">p0_red</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">_get_linear_nd_reduced</span><span class="p">(</span><span class="n">x_temp</span><span class="p">,</span> <span class="n">cov_inv</span><span class="p">,</span> <span class="n">popt</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="s1">&#39;func&#39;</span><span class="p">),</span> <span class="n">p0_red</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;Newton-CG&#39;</span><span class="p">,</span>
                   <span class="n">jac</span><span class="o">=</span><span class="n">_get_linear_nd_reduced</span><span class="p">(</span><span class="n">x_temp</span><span class="p">,</span> <span class="n">cov_inv</span><span class="p">,</span> <span class="n">popt</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="s1">&#39;jac&#39;</span><span class="p">),</span>
                   <span class="n">hess</span><span class="o">=</span><span class="n">_get_linear_nd_reduced</span><span class="p">(</span><span class="n">x_temp</span><span class="p">,</span> <span class="n">cov_inv</span><span class="p">,</span> <span class="n">popt</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="s1">&#39;hess&#39;</span><span class="p">),</span> <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;xtol&#39;</span><span class="p">:</span> <span class="mf">1e-15</span><span class="p">})</span>

    <span class="n">popt</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>

    <span class="k">def</span> <span class="nf">get_cov</span><span class="p">(</span><span class="n">_popt</span><span class="p">):</span>
        <span class="n">h2</span> <span class="o">=</span> <span class="n">_linear_nd_hess</span><span class="p">(</span><span class="n">_popt</span><span class="p">,</span> <span class="n">x_temp</span><span class="p">,</span> <span class="n">cov_inv</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">mask</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">h2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">optimize_cov</span><span class="p">:</span>  <span class="c1"># Minimize the covariances by shifting the origin vector of the straight.</span>
        <span class="k">def</span> <span class="nf">get_cov_t</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">_popt</span><span class="p">):</span>
            <span class="n">_popt_cov</span> <span class="o">=</span> <span class="n">_popt</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">_popt_cov</span><span class="p">[:</span><span class="n">dim</span><span class="p">]</span> <span class="o">+=</span> <span class="n">t</span> <span class="o">*</span> <span class="n">_popt_cov</span><span class="p">[</span><span class="n">dim</span><span class="p">:]</span>  <span class="c1"># Shift the origin vector by t.</span>
            <span class="k">return</span> <span class="n">get_cov</span><span class="p">(</span><span class="n">_popt_cov</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">cost_cov</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">_popt</span><span class="p">):</span>
            <span class="n">_pcov</span> <span class="o">=</span> <span class="n">get_cov_t</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">_popt</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">_pcov</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># Sum over the square of all covariances.</span>
            <span class="k">return</span> <span class="n">ret</span>

        <span class="k">def</span> <span class="nf">get_cost_cov</span><span class="p">(</span><span class="n">_popt</span><span class="p">):</span>
            <span class="k">return</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">cost_cov</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">_popt</span><span class="p">)</span>

        <span class="c1"># Set the origin point to the center of the data before optimization.</span>
        <span class="n">tp</span> <span class="o">=</span> <span class="n">_linear_nd_t0</span><span class="p">(</span><span class="n">popt</span><span class="p">,</span> <span class="n">x_temp</span><span class="p">,</span> <span class="n">cov_inv</span><span class="p">)</span>
        <span class="n">popt</span><span class="p">[:</span><span class="n">dim</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">popt</span><span class="p">[</span><span class="n">dim</span><span class="p">:]</span>
        <span class="n">tp</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>  <span class="c1"># Start at a value between all data points other than 0.</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">get_cost_cov</span><span class="p">(</span><span class="n">popt</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">tp</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;BFGS&#39;</span><span class="p">)</span>
        <span class="n">popt</span><span class="p">[:</span><span class="n">dim</span><span class="p">]</span> <span class="o">+=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">popt</span><span class="p">[</span><span class="n">dim</span><span class="p">:]</span>

    <span class="k">if</span> <span class="n">axis_was_none</span><span class="p">:</span>
        <span class="n">popt</span><span class="p">[</span><span class="n">dim</span><span class="p">:]</span> <span class="o">/=</span> <span class="n">tools</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="n">dim</span><span class="p">:])</span>

    <span class="c1"># plt.cla()</span>
    <span class="c1"># plt.clf()</span>
    <span class="c1"># for i in range(4):</span>
    <span class="c1">#     plt.subplot(2, 2, i + 1)</span>
    <span class="c1">#     draw_sigma2d(x_temp[:, 0], x_temp[:, i + 1], np.sqrt(cov_temp[:, 0, 0]),</span>
    <span class="c1">#                  np.sqrt(cov_temp[:, i + 1, i + 1]), cov_temp[:, 0, i + 1]</span>
    <span class="c1">#                  / (np.sqrt(cov_temp[:, 0, 0]) * np.sqrt(cov_temp[:, i + 1, i + 1])))</span>
    <span class="c1">#     plt.plot(x_temp[:, 0], straight(x_temp[:, 0], popt[i + 1], popt[6 + i]))</span>
    <span class="c1"># plt.show()</span>

    <span class="n">popt</span><span class="p">[:</span><span class="n">dim</span><span class="p">]</span> <span class="o">*=</span> <span class="n">x_fac</span>
    <span class="n">popt</span><span class="p">[</span><span class="n">dim</span><span class="p">:]</span> <span class="o">*=</span> <span class="n">x_fac</span> <span class="o">/</span> <span class="n">x_fac</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span>
    <span class="n">x_temp</span> <span class="o">*=</span> <span class="n">x_fac</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">cov_temp</span> <span class="o">*=</span> <span class="n">x_fac</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">x_fac</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span>

    <span class="n">popt</span><span class="p">[:</span><span class="n">dim</span><span class="p">]</span> <span class="o">+=</span> <span class="n">x_off</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">optimize_cov</span><span class="p">:</span>
        <span class="n">popt</span><span class="p">[:</span><span class="n">dim</span><span class="p">]</span> <span class="o">-=</span> <span class="n">popt</span><span class="p">[</span><span class="n">dim</span><span class="p">:]</span> <span class="o">*</span> <span class="n">popt</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">/</span> <span class="n">popt</span><span class="p">[</span><span class="n">dim</span> <span class="o">+</span> <span class="n">axis</span><span class="p">]</span>
    <span class="n">x_temp</span> <span class="o">+=</span> <span class="n">x_off</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">cov_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cov_temp</span><span class="p">)</span>

    <span class="n">pcov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dim</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">pcov</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">mask</span><span class="p">)]</span> <span class="o">=</span> <span class="n">get_cov</span><span class="p">(</span><span class="n">popt</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span></div>


<div class="viewcode-block" id="linear_fit"><a class="viewcode-back" href="../../../qspec.html#qspec.analyze.linear_fit">[docs]</a><span class="k">def</span> <span class="nf">linear_fit</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">array_iter</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">array_iter</span><span class="p">,</span> <span class="n">sigma_x</span><span class="p">:</span> <span class="n">array_iter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sigma_y</span><span class="p">:</span> <span class="n">array_iter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">corr</span><span class="p">:</span> <span class="n">array_iter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">report</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Maximum likelihood fit for a straight line in 2d. This is a wrapper for the more general &#39;linear_nd_fit&#39; function.</span>

<span class="sd">    :param x: The x data.</span>
<span class="sd">    :param y: The y data.</span>
<span class="sd">    :param sigma_x: The 1-sigma uncertainties of the x data.</span>
<span class="sd">    :param sigma_y: The 1-sigma uncertainties of the y data.</span>
<span class="sd">    :param corr: The correlation coefficients between the x and y data.</span>
<span class="sd">    :param report: Whether to print the result of the fit.</span>
<span class="sd">    :param kwargs: Additional keyword arguments.</span>
<span class="sd">    :returns: popt, pcov. The best y-intercept and slope and their covariance matrix.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">sigma_x</span><span class="p">,</span> <span class="n">sigma_y</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">asarray_optional</span><span class="p">(</span><span class="n">sigma_x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span> <span class="n">tools</span><span class="o">.</span><span class="n">asarray_optional</span><span class="p">(</span><span class="n">sigma_y</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">x</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">y</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">sigma_x</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">sigma_y</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">cov</span> <span class="o">=</span> <span class="n">covariance_matrix</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">corr</span><span class="o">=</span><span class="n">corr</span><span class="p">)</span>

    <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">linear_nd_fit</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">cov</span><span class="o">=</span><span class="n">cov</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">optimize_cov</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pcov</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">report</span><span class="p">:</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">printh</span><span class="p">(</span><span class="s1">&#39;linear_fit result:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;a: </span><span class="si">{}</span><span class="s1"> +/- </span><span class="si">{}</span><span class="se">\n</span><span class="s1">b: </span><span class="si">{}</span><span class="s1"> +/- </span><span class="si">{}</span><span class="se">\n</span><span class="s1">corr_ab: </span><span class="si">{}</span><span class="s1">&#39;</span>
              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pcov</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pcov</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
                      <span class="n">pcov</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pcov</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">pcov</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])))</span>

    <span class="k">return</span> <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span></div>


<span class="k">def</span> <span class="nf">_test_order_linear_nd_monte_carlo</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">cov</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">,</span>
                                      <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;py&#39;</span><span class="p">,</span> <span class="n">report</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param x: The data vectors. Must have shape (k, n), where k is the number of data points</span>
<span class="sd">     and n is the number of dimensions of each point.</span>
<span class="sd">    :param cov: The covariance matrices of the data vectors. Must have shape (k, n, n).</span>
<span class="sd">     Use &#39;covariance_matrix&#39; to construct covariance matrices.</span>
<span class="sd">    :param n_samples: Maximum number of generated samples.</span>
<span class="sd">     If None and method == &#39;cpp&#39;, samples are generated until &#39;n_accepted&#39; samples get accepted.</span>
<span class="sd">    :param method: The method to generate the collinear points. Can be one of {&#39;py&#39;, &#39;cpp&#39;}.</span>
<span class="sd">     The &#39;py&#39; version is faster but only allows to specify &#39;n_samples&#39;.</span>
<span class="sd">     The &#39;cpp&#39; version is slower but allows to specify both &#39;n_accepted&#39; and &#39;n_samples&#39;.</span>
<span class="sd">    :param report: Whether to report the number of samples.</span>
<span class="sd">    :param kwargs: Additional keyword arguments to be passed to the chosen method. &#39;py&#39;: {}. &#39;cpp&#39;: {seed=None}.</span>
<span class="sd">    :returns: The order of axis 0 of &#39;x&#39; which yields the most accepted samples.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">]</span>
    <span class="n">best_n</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">best_order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="n">i</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">!=</span> <span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">])</span>
        <span class="n">_x</span><span class="p">,</span> <span class="n">_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">order</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">cov</span><span class="p">[</span><span class="n">order</span><span class="p">])</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">n_accepted</span><span class="p">,</span> <span class="n">n_samples</span> <span class="o">=</span> \
            <span class="n">generate_collinear_points</span><span class="p">(</span><span class="n">_x</span><span class="p">,</span> <span class="n">_cov</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">report</span><span class="o">=</span><span class="n">report</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_accepted</span> <span class="o">&gt;</span> <span class="n">best_n</span><span class="p">:</span>
            <span class="n">best_n</span> <span class="o">=</span> <span class="n">n_accepted</span>
            <span class="n">best_order</span> <span class="o">=</span> <span class="n">order</span>
    <span class="k">return</span> <span class="n">best_order</span>


<div class="viewcode-block" id="generate_collinear_points_py"><a class="viewcode-back" href="../../../qspec.html#qspec.analyze.generate_collinear_points_py">[docs]</a><span class="k">def</span> <span class="nf">generate_collinear_points_py</span><span class="p">(</span><span class="n">mean</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">cov</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">,</span> <span class="n">report</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param mean: The data vectors. Must have shape (k, n), where k is the number of data points</span>
<span class="sd">     and n is the number of dimensions of each point.</span>
<span class="sd">    :param cov: The covariance matrices of the data vectors. Must have shape (k, n, n).</span>
<span class="sd">     Use &#39;covariance_matrix&#39; to construct covariance matrices.</span>
<span class="sd">    :param n_samples: The number of samples generated for each data point.</span>
<span class="sd">    :param report: Whether to report the number of samples.</span>
<span class="sd">    :param kwargs: Additional keyword arguments.</span>
<span class="sd">    :returns: The randomly generated data vectors p with shape (n_accepted, k ,n) aligned along a straight line</span>
<span class="sd">     and the number of accepted and generated samples.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">n_samples</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n_samples</span> <span class="o">=</span> <span class="mi">100000</span>
    <span class="n">p_0</span> <span class="o">=</span> <span class="n">multivariate_normal</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="n">mean</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cov</span><span class="o">=</span><span class="n">cov</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="n">n_samples</span><span class="p">)</span>
    <span class="n">p_1</span> <span class="o">=</span> <span class="n">multivariate_normal</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="n">mean</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">cov</span><span class="o">=</span><span class="n">cov</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="n">n_samples</span><span class="p">)</span>
    <span class="n">dr</span> <span class="o">=</span> <span class="n">straight_direction</span><span class="p">(</span><span class="n">p_0</span><span class="p">,</span> <span class="n">p_1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">cov_inv</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cov_i</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">cov_i</span> <span class="ow">in</span> <span class="n">cov</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="n">tools</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">cov_i</span><span class="p">,</span> <span class="n">dr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">cov_i</span> <span class="ow">in</span> <span class="n">cov_inv</span><span class="p">]</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dr</span> <span class="o">*</span> <span class="n">a_i</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span> <span class="k">for</span> <span class="n">a_i</span> <span class="ow">in</span> <span class="n">a</span><span class="p">]</span>
    <span class="n">t_0</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">p_0</span> <span class="o">-</span> <span class="n">x_i</span><span class="p">)</span> <span class="o">*</span> <span class="n">a_i</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma_i</span> <span class="o">**</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">x_i</span><span class="p">,</span> <span class="n">a_i</span><span class="p">,</span> <span class="n">sigma_i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mean</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">a</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)]</span>
    <span class="n">t</span> <span class="o">=</span> <span class="p">[</span><span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">t_0_i</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma_i</span><span class="p">)</span> <span class="k">for</span> <span class="n">t_0_i</span><span class="p">,</span> <span class="n">sigma_i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">t_0</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)]</span>

    <span class="n">p_new</span> <span class="o">=</span> <span class="p">[</span><span class="n">p_0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">t_i</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dr</span> <span class="k">for</span> <span class="n">t_i</span> <span class="ow">in</span> <span class="n">t</span><span class="p">]</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">([</span><span class="n">multivariate_normal</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">p_i</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="n">x_i</span><span class="p">,</span> <span class="n">cov</span><span class="o">=</span><span class="n">cov_i</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">p_i</span><span class="p">,</span> <span class="n">x_i</span><span class="p">,</span> <span class="n">cov_i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">p_new</span><span class="p">,</span> <span class="n">mean</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">cov</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">([</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">t_i</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">t_0_i</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma_i</span><span class="p">)</span> <span class="k">for</span> <span class="n">t_i</span><span class="p">,</span> <span class="n">t_0_i</span><span class="p">,</span> <span class="n">sigma_i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">t_0</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">p_new</span><span class="p">:</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">f</span> <span class="o">/</span> <span class="n">g</span>
        <span class="n">u</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="n">accepted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">n_samples</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">u</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">p_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">p_new</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">p_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">accepted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">p_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">p_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">n_accepted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">accepted</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">report</span><span class="p">:</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">print_colored</span><span class="p">(</span><span class="s1">&#39;OKGREEN&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Accepted samples: </span><span class="si">{</span><span class="n">n_accepted</span><span class="si">}</span><span class="s1"> / </span><span class="si">{</span><span class="n">n_samples</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">p</span><span class="p">[</span><span class="n">accepted</span><span class="p">],</span> <span class="n">n_accepted</span><span class="p">,</span> <span class="n">n_samples</span></div>


<span class="k">def</span> <span class="nf">generate_collinear_points</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">cov</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n_accepted</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                              <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;py&#39;</span><span class="p">,</span> <span class="n">report</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param x: The data vectors. Must have shape (k, n), where k is the number of data points</span>
<span class="sd">     and n is the number of dimensions of each point.</span>
<span class="sd">    :param cov: The covariance matrices of the data vectors. Must have shape (k, n, n).</span>
<span class="sd">     Use &#39;covariance_matrix&#39; to construct covariance matrices.</span>
<span class="sd">    :param n_samples: Maximum number of generated samples.</span>
<span class="sd">     If None and method == &#39;cpp&#39;, samples are generated until &#39;n_accepted&#39; samples get accepted.</span>
<span class="sd">    :param n_accepted: The number of samples to be accepted for each data point. Only available if method == &#39;cpp&#39;.</span>
<span class="sd">    :param method: The method to generate the collinear points. Can be one of {&#39;py&#39;, &#39;cpp&#39;}.</span>
<span class="sd">     The &#39;py&#39; version is faster but only allows to specify &#39;n_samples&#39;.</span>
<span class="sd">     The &#39;cpp&#39; version is slower but allows to specify both &#39;n_accepted&#39; and &#39;n_samples&#39;.</span>
<span class="sd">    :param report: Whether to report the number of samples.</span>
<span class="sd">    :param kwargs: Additional keyword arguments to be passed to the chosen method. &#39;py&#39;: {}. &#39;cpp&#39;: {seed=None}.</span>
<span class="sd">    :returns: The randomly generated data vectors p with shape (n_accepted, k ,n) aligned along a straight line</span>
<span class="sd">     and the number of accepted and generated samples.</span>
<span class="sd">    :raises ValueError: &#39;method&#39; must be in {&#39;py&#39;, &#39;cpp&#39;}.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;py&#39;</span><span class="p">,</span> <span class="s1">&#39;cpp&#39;</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">m</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">method</span><span class="se">\&#39;</span><span class="s1"> (</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s1">) must be in </span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;py&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">generate_collinear_points_py</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">report</span><span class="o">=</span><span class="n">report</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">generate_collinear_points_cpp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">n_accepted</span><span class="o">=</span><span class="n">n_accepted</span><span class="p">,</span> <span class="n">report</span><span class="o">=</span><span class="n">report</span><span class="p">,</span>
                                             <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<div class="viewcode-block" id="linear_nd_monte_carlo"><a class="viewcode-back" href="../../../qspec.html#qspec.analyze.linear_nd_monte_carlo">[docs]</a><span class="k">def</span> <span class="nf">linear_nd_monte_carlo</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">array_iter</span><span class="p">,</span> <span class="n">cov</span><span class="p">:</span> <span class="n">array_iter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">optimize_cov</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                          <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n_accepted</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">optimize_sampling</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                          <span class="n">return_samples</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;py&#39;</span><span class="p">,</span> <span class="n">report</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Monte-Carlo fitter that finds a straight line in n-dimensional space.</span>

<span class="sd">    :param x: The data vectors. Must have shape (k, n), where k is the number of data points</span>
<span class="sd">     and n is the number of dimensions of each point.</span>
<span class="sd">    :param cov: The covariance matrices of the data vectors. Must have shape (k, n, n).</span>
<span class="sd">     Use &#39;covariance_matrix&#39; to construct covariance matrices.</span>
<span class="sd">     If None, samples are generated until n samples get accepted.</span>
<span class="sd">    :param axis: The component of the n-dimensional vectors which are fixed for fitting.</span>
<span class="sd">     This is required since a straight in n dimensions is fully described by 2 (n - 1) parameters.</span>
<span class="sd">    :param optimize_cov: If True, the origin vector of the straight is optimized to yield the smallest covariances.</span>
<span class="sd">    :param n_samples: Maximum number of generated samples.</span>
<span class="sd">     If None and method == &#39;cpp&#39;, samples are generated until &#39;n_accepted&#39; samples get accepted.</span>
<span class="sd">    :param n_accepted: The number of samples to be accepted for each data point. Only available if method == &#39;cpp&#39;.</span>
<span class="sd">    :param optimize_sampling: Whether to optimize the sampling from the data.</span>
<span class="sd">    :param return_samples: Whether to also return the generated points &#39;p&#39;. &#39;p&#39; has shape (n_samples, k ,n).</span>
<span class="sd">    :param method: The method to generate the collinear points. Can be one of {&#39;py&#39;, &#39;cpp&#39;}.</span>
<span class="sd">     The &#39;py&#39; version is faster but only allows to specify &#39;n_samples&#39;.</span>
<span class="sd">     The &#39;cpp&#39; version is slower but allows to specify both &#39;n_accepted&#39; and &#39;n_samples&#39;.</span>
<span class="sd">    :param report: Whether to print the result of the fit.</span>
<span class="sd">    :param kwargs: Additional keyword arguments to be passed to the chosen method. &#39;py&#39;: {}. &#39;cpp&#39;: {seed=None}.</span>
<span class="sd">    :returns: popt, pcov (, p). The optimized parameters and their covariances.</span>
<span class="sd">     If &#39;return_samples&#39; is True, also returns the generated points &#39;p&#39;.</span>
<span class="sd">     The resulting shapes are (2n, ), (2n, 2n) and (n_samples, k ,n).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">size</span><span class="p">,</span> <span class="n">dim</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">cov</span> <span class="o">=</span> <span class="n">covariance_matrix</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">dim</span><span class="p">)</span>

    <span class="n">axis_was_none</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axis_was_none</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">axis</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">axis</span> <span class="o">+=</span> <span class="n">dim</span>

    <span class="k">if</span> <span class="n">optimize_sampling</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">report</span><span class="p">:</span>
            <span class="n">tools</span><span class="o">.</span><span class="n">printh</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Optimizing sampling:&#39;</span><span class="p">)</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">_test_order_linear_nd_monte_carlo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">report</span><span class="o">=</span><span class="n">report</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

    <span class="n">inverse_order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">order</span> <span class="o">==</span> <span class="n">i</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">size</span><span class="p">)])</span>  <span class="c1"># Invert the order for later.</span>

    <span class="k">if</span> <span class="n">report</span><span class="p">:</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">printh</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Generating samples:&#39;</span><span class="p">)</span>
    <span class="n">_x</span><span class="p">,</span> <span class="n">_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">order</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">cov</span><span class="p">[</span><span class="n">order</span><span class="p">])</span>
    <span class="n">p</span><span class="p">,</span> <span class="n">n_accepted</span><span class="p">,</span> <span class="n">n_samples</span> <span class="o">=</span> <span class="n">generate_collinear_points</span><span class="p">(</span><span class="n">_x</span><span class="p">,</span> <span class="n">_cov</span><span class="p">,</span> <span class="n">n_accepted</span><span class="o">=</span><span class="n">n_accepted</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="n">n_samples</span><span class="p">,</span>
                                                         <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">report</span><span class="o">=</span><span class="n">report</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">p0</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">dr</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">p0</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="n">inverse_order</span><span class="p">,</span> <span class="p">:]</span>

    <span class="n">s</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">p0_mean</span><span class="p">,</span> <span class="n">dr_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">p0</span><span class="p">[:,</span> <span class="p">[</span><span class="n">axis</span><span class="p">]]),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dr</span><span class="p">[:,</span> <span class="p">[</span><span class="n">axis</span><span class="p">]])</span>
    <span class="k">if</span> <span class="n">optimize_cov</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">get_cov_t</span><span class="p">(</span><span class="n">t_opt</span><span class="p">,</span> <span class="n">_p0</span><span class="p">,</span> <span class="n">_dr</span><span class="p">):</span>
            <span class="n">p0_opt</span> <span class="o">=</span> <span class="n">_p0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">_t</span> <span class="o">=</span> <span class="p">(</span><span class="n">t_opt</span> <span class="o">-</span> <span class="n">p0</span><span class="p">[:,</span> <span class="p">[</span><span class="n">axis</span><span class="p">]])</span> <span class="o">/</span> <span class="n">dr</span><span class="p">[:,</span> <span class="p">[</span><span class="n">axis</span><span class="p">]]</span>
            <span class="n">p0_opt</span> <span class="o">+=</span> <span class="n">_t</span> <span class="o">*</span> <span class="n">_dr</span>  <span class="c1"># Shift the origin vector by t.</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">p0_opt</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">_dr</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">cost_cov</span><span class="p">(</span><span class="n">t_opt</span><span class="p">,</span> <span class="n">_p0</span><span class="p">,</span> <span class="n">_dr</span><span class="p">):</span>
            <span class="n">_pcov</span> <span class="o">=</span> <span class="n">get_cov_t</span><span class="p">(</span><span class="n">t_opt</span><span class="p">,</span> <span class="n">_p0</span><span class="p">,</span> <span class="n">_dr</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">_pcov</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># Sum over the square of all covariances.</span>

        <span class="k">def</span> <span class="nf">get_cost_cov</span><span class="p">(</span><span class="n">_p0</span><span class="p">,</span> <span class="n">_dr</span><span class="p">):</span>
            <span class="k">return</span> <span class="k">lambda</span> <span class="n">t_opt</span><span class="p">:</span> <span class="n">cost_cov</span><span class="p">(</span><span class="n">t_opt</span><span class="p">,</span> <span class="n">_p0</span><span class="p">,</span> <span class="n">_dr</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">get_cost_cov</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">dr</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;BFGS&#39;</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span> <span class="o">-</span> <span class="n">p0</span><span class="p">[:,</span> <span class="p">[</span><span class="n">axis</span><span class="p">]])</span> <span class="o">/</span> <span class="n">dr</span><span class="p">[:,</span> <span class="p">[</span><span class="n">axis</span><span class="p">]]</span>
    <span class="n">p0</span> <span class="o">+=</span> <span class="n">t</span> <span class="o">*</span> <span class="n">dr</span>

    <span class="k">if</span> <span class="n">axis_was_none</span><span class="p">:</span>
        <span class="n">dr</span> <span class="o">/=</span> <span class="n">tools</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">dr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dr</span> <span class="o">/=</span> <span class="n">dr</span><span class="p">[:,</span> <span class="p">[</span><span class="n">axis</span><span class="p">]]</span>

    <span class="n">popt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">pcov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">dr</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_samples</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span><span class="p">,</span> <span class="n">p</span>
    <span class="k">return</span> <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span></div>


<div class="viewcode-block" id="linear_monte_carlo"><a class="viewcode-back" href="../../../qspec.html#qspec.analyze.linear_monte_carlo">[docs]</a><span class="k">def</span> <span class="nf">linear_monte_carlo</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">array_iter</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">array_iter</span><span class="p">,</span> <span class="n">sigma_x</span><span class="p">:</span> <span class="n">array_iter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sigma_y</span><span class="p">:</span> <span class="n">array_iter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">corr</span><span class="p">:</span> <span class="n">array_iter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">optimize_cov</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">n_accepted</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">optimize_sampling</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">return_samples</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                       <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;py&#39;</span><span class="p">,</span> <span class="n">report</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper for linear_nd_monte_carlo.</span>

<span class="sd">    :param x: The x data. Must be a 1-d array.</span>
<span class="sd">    :param y: The y data. Must be a 1-d array.</span>
<span class="sd">    :param sigma_x: The 1-sigma uncertainties of the x data. Must be a 1-d array.</span>
<span class="sd">    :param sigma_y: The 1-sigma uncertainties of the y data. Must be a 1-d array.</span>
<span class="sd">    :param corr: The correlation coefficients between the x and y data. Must be a 1-d array.</span>
<span class="sd">    :param optimize_cov: If True, the origin vector of the straight is optimized to yield the smallest covariances.</span>
<span class="sd">    :param n_samples: Maximum number of generated samples.</span>
<span class="sd">     If None and method == &#39;cpp&#39;, samples are generated until &#39;n_accepted&#39; samples get accepted.</span>
<span class="sd">    :param n_accepted: The number of samples to be accepted for each data point. Only available if method == &#39;cpp&#39;.</span>
<span class="sd">    :param optimize_sampling: Whether to optimize the sampling from the data.</span>
<span class="sd">    :param return_samples: Whether to also return the generated points &#39;p&#39;. &#39;p&#39; has shape (n_samples, k ,2).</span>
<span class="sd">    :param method: The method to generate the collinear points. Can be one of {&#39;py&#39;, &#39;cpp&#39;}.</span>
<span class="sd">     The &#39;py&#39; version is faster but only allows to specify &#39;n_samples&#39;.</span>
<span class="sd">     The &#39;cpp&#39; version is slower but allows to specify both &#39;n_accepted&#39; and &#39;n_samples&#39;.</span>
<span class="sd">    :param report: Whether to print the result of the fit.</span>
<span class="sd">    :param kwargs: Additional keyword arguments.</span>
<span class="sd">    :returns: a, b, sigma_a, sigma_b, corr_ab. The best y-intercept and slope,</span>
<span class="sd">     their respective 1-sigma uncertainties and their correlation coefficient.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">sigma_x</span><span class="p">,</span> <span class="n">sigma_y</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">asarray_optional</span><span class="p">(</span><span class="n">sigma_x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span> <span class="n">tools</span><span class="o">.</span><span class="n">asarray_optional</span><span class="p">(</span><span class="n">sigma_y</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">x</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">y</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">sigma_x</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">sigma_y</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">cov</span> <span class="o">=</span> <span class="n">covariance_matrix</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">corr</span><span class="o">=</span><span class="n">corr</span><span class="p">)</span>

    <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">linear_nd_monte_carlo</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">cov</span><span class="o">=</span><span class="n">cov</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">optimize_cov</span><span class="o">=</span><span class="n">optimize_cov</span><span class="p">,</span> <span class="n">n_accepted</span><span class="o">=</span><span class="n">n_accepted</span><span class="p">,</span>
                                          <span class="n">n_samples</span><span class="o">=</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">optimize_sampling</span><span class="o">=</span><span class="n">optimize_sampling</span><span class="p">,</span>
                                          <span class="n">return_samples</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">report</span><span class="o">=</span><span class="n">report</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pcov</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">return_samples</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span><span class="p">,</span> <span class="n">p</span>
    <span class="k">return</span> <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span></div>


<div class="viewcode-block" id="linear_alpha_fit"><a class="viewcode-back" href="../../../qspec.html#qspec.analyze.linear_alpha_fit">[docs]</a><span class="k">def</span> <span class="nf">linear_alpha_fit</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">array_iter</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">array_iter</span><span class="p">,</span> <span class="n">sigma_x</span><span class="p">:</span> <span class="n">array_like</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sigma_y</span><span class="p">:</span> <span class="n">array_like</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">corr</span><span class="p">:</span> <span class="n">array_iter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">york_fit</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="n">scalar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                     <span class="n">find_alpha</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">report</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">show</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param x: The x data.</span>
<span class="sd">    :param y: The y data.</span>
<span class="sd">    :param sigma_x: The 1-sigma uncertainty of the x data.</span>
<span class="sd">    :param sigma_y: The 1-sigma uncertainty of the y data.</span>
<span class="sd">    :param corr: The correlation coefficients between the x and y data.</span>
<span class="sd">    :param func: The fitting routine. Supports {&#39;york_fit&#39;, &#39;linear_fit&#39;, &#39;linear_monte_carlo&#39;}.</span>
<span class="sd">    :param alpha: An x-axis offset to reduce the correlation coefficient between the y-intercept and the slope.</span>
<span class="sd">    :param find_alpha: Whether to search for the best &#39;alpha&#39;. Uses the given &#39;alpha&#39; as a starting point.</span>
<span class="sd">     May not give the desired result if &#39;alpha&#39; was initialized too far from its optimal value.</span>
<span class="sd">    :param report: Whether to print the result of the fit.</span>
<span class="sd">    :param show: Whether to plot the fit result.</span>
<span class="sd">    :param kwargs: Additional keyword arguments are passed to the fitting routine.</span>
<span class="sd">    :returns: popt, pcov, alpha. The best y-intercept and slope, their covariance matrix and the used alpha.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#  TODO: minimize tolerances.</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">floor_log10</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">funcs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;york_fit&#39;</span><span class="p">,</span> <span class="s1">&#39;linear_fit&#39;</span><span class="p">,</span> <span class="s1">&#39;linear_monte_carlo&#39;</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">func</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">func</span><span class="se">\&#39;</span><span class="s1"> must be in </span><span class="si">{</span><span class="n">funcs</span><span class="si">}</span><span class="s1"> but is </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">.&#39;</span><span class="p">)</span>
        <span class="n">func</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cost</span><span class="p">(</span><span class="n">x0</span><span class="p">):</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">,</span> <span class="n">sigma_x</span><span class="o">=</span><span class="n">sigma_x</span><span class="p">,</span> <span class="n">sigma_y</span><span class="o">=</span><span class="n">sigma_y</span><span class="p">,</span> <span class="n">corr</span><span class="o">=</span><span class="n">corr</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># print(&#39;alpha: {}(1.), \tcost: {}({})&#39;.format(x0[0], c ** 2 * 10. ** (n + 1), 10. ** (n - 3)))</span>
        <span class="k">return</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="mf">10.</span> <span class="o">**</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">find_alpha</span><span class="p">:</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">cost</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">alpha</span><span class="p">]),</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;Nelder-Mead&#39;</span><span class="p">,</span>
                         <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;xatol&#39;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">,</span> <span class="s1">&#39;fatol&#39;</span><span class="p">:</span> <span class="mf">0.01</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="mf">10.</span> <span class="o">**</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)})</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sigma_x</span><span class="o">=</span><span class="n">sigma_x</span><span class="p">,</span> <span class="n">sigma_y</span><span class="o">=</span><span class="n">sigma_y</span><span class="p">,</span> <span class="n">corr</span><span class="o">=</span><span class="n">corr</span><span class="p">,</span> <span class="n">report</span><span class="o">=</span><span class="n">report</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="n">show</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">report</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;alpha: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alpha</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span><span class="p">,</span> <span class="n">alpha</span></div>


<div class="viewcode-block" id="odr_fit"><a class="viewcode-back" href="../../../qspec.html#qspec.analyze.odr_fit">[docs]</a><span class="k">def</span> <span class="nf">odr_fit</span><span class="p">(</span><span class="n">f</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">array_iter</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">array_iter</span><span class="p">,</span> <span class="n">sigma_x</span><span class="p">:</span> <span class="n">array_iter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sigma_y</span><span class="p">:</span> <span class="n">array_iter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">p0</span><span class="p">:</span> <span class="n">array_iter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">p0_d</span><span class="p">:</span> <span class="n">array_iter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">p0_fixed</span><span class="p">:</span> <span class="n">array_iter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">report</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">ndarray</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param f: The model function to fit to the data.</span>
<span class="sd">    :param x: The x data.</span>
<span class="sd">    :param y: The y data.</span>
<span class="sd">    :param sigma_x: The 1-sigma uncertainty of the x data.</span>
<span class="sd">    :param sigma_y: The 1-sigma uncertainty of the y data.</span>
<span class="sd">    :param p0: A numpy array or an Iterable of the initial guesses for the parameters.</span>
<span class="sd">     Must have at least the same length as the minimum number of parameters required by the function &#39;f&#39;.</span>
<span class="sd">     If &#39;p0&#39; is None, 1 is taken as an initial guess for all non-keyword parameters.</span>
<span class="sd">    :param p0_d: A numpy array or an Iterable of the uncertainties of the initial guesses for the parameters.</span>
<span class="sd">     Must have the same length as p0.</span>
<span class="sd">    :param p0_fixed: A numpy array or an Iterable of bool values specifying, whether to fix a parameter.</span>
<span class="sd">     Must have the same length as p0.</span>
<span class="sd">    :param report: Whether to print the result of the fit.</span>
<span class="sd">    :param kwargs: Additional keyword arguments are passed to odr.ODR.</span>
<span class="sd">    :returns: popt, pcov. The optimal parameters and their covariance matrix.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">covx</span><span class="p">,</span> <span class="n">covy</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">sigma_x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sigma_x</span><span class="p">)</span>
        <span class="c1"># if sigma_x.shape == (x.size, x.size):</span>
        <span class="c1">#     covx = sigma_x</span>
        <span class="c1">#     sy = None</span>
    <span class="k">if</span> <span class="n">sigma_y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sigma_y</span><span class="p">)</span>
        <span class="c1"># if sigma_y.shape == (y.size, y.size):</span>
        <span class="c1">#     covy = sigma_y</span>
        <span class="c1">#     sy = None</span>
    <span class="k">if</span> <span class="n">p0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">arg_spec</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg_spec</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">arg_spec</span><span class="o">.</span><span class="n">defaults</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">arg_spec</span><span class="o">.</span><span class="n">defaults</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">n</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg_spec</span><span class="o">.</span><span class="n">defaults</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">f</span><span class="se">\&#39;</span><span class="s1"> must have at least one parameter that can be optimized.&#39;</span><span class="p">)</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="p">]</span> <span class="o">*</span> <span class="n">n</span>
        <span class="k">if</span> <span class="n">arg_spec</span><span class="o">.</span><span class="n">defaults</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">p0</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg_spec</span><span class="o">.</span><span class="n">defaults</span><span class="p">))</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">p0</span><span class="p">)</span>

    <span class="n">ifixb</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">p0_fixed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ifixb</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">p0_fixed</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ifixb</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">p0</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">p0_fixed</span><span class="se">\&#39;</span><span class="s1"> must have the same shape as </span><span class="se">\&#39;</span><span class="s1">p0</span><span class="se">\&#39;</span><span class="s1">.&#39;</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">odr</span><span class="o">.</span><span class="n">RealData</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sx</span><span class="o">=</span><span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="o">=</span><span class="n">sy</span><span class="p">,</span> <span class="n">covx</span><span class="o">=</span><span class="n">covx</span><span class="p">,</span> <span class="n">covy</span><span class="o">=</span><span class="n">covy</span><span class="p">)</span>
    <span class="c1"># noinspection PyTypeChecker</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">odr</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="k">lambda</span> <span class="n">beta</span><span class="p">,</span> <span class="n">x_i</span><span class="p">:</span> <span class="n">f</span><span class="p">(</span><span class="n">x_i</span><span class="p">,</span> <span class="o">*</span><span class="n">beta</span><span class="p">))</span>
    <span class="n">odr_i</span> <span class="o">=</span> <span class="n">odr</span><span class="o">.</span><span class="n">ODR</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">beta0</span><span class="o">=</span><span class="n">p0</span><span class="p">,</span> <span class="n">delta0</span><span class="o">=</span><span class="n">p0_d</span><span class="p">,</span> <span class="n">ifixb</span><span class="o">=</span><span class="n">ifixb</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">odr_i</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">report</span><span class="p">:</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">printh</span><span class="p">(</span><span class="s1">&#39;odr_fit result:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">cov_beta</span><span class="p">)))):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1"> +/- </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">cov_beta</span></div>


<div class="viewcode-block" id="curve_fit"><a class="viewcode-back" href="../../../qspec.html#qspec.analyze.curve_fit">[docs]</a><span class="k">def</span> <span class="nf">curve_fit</span><span class="p">(</span><span class="n">f</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">array_like</span><span class="p">,</span> <span class="nb">object</span><span class="p">],</span> <span class="n">y</span><span class="p">:</span> <span class="n">array_like</span><span class="p">,</span> <span class="n">p0</span><span class="p">:</span> <span class="n">array_iter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
              <span class="n">p0_fixed</span><span class="p">:</span> <span class="n">array_iter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sigma</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">array_iter</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">absolute_sigma</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
              <span class="n">check_finite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">bounds</span><span class="p">:</span> <span class="p">(</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">ndarray</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
              <span class="n">jac</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">full_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">report</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param f: The model function to fit to the data.</span>
<span class="sd">    :param x: The x data.</span>
<span class="sd">    :param y: The y data.</span>
<span class="sd">    :param p0: A numpy array or an Iterable of the initial guesses for the parameters.</span>
<span class="sd">     Must have at least the same length as the minimum number of parameters required by the function &#39;f&#39;.</span>
<span class="sd">     If &#39;p0&#39; is None, 1 is taken as an initial guess for all non-keyword parameters.</span>
<span class="sd">    :param p0_fixed: A numpy array or an Iterable of bool values specifying, whether to fix a parameter.</span>
<span class="sd">     Must have the same length as p0.</span>
<span class="sd">    :param sigma: The 1-sigma uncertainty of the y data.</span>
<span class="sd">     This can also be a function g such that &#39;g(x, y, f(x, \*params), \*params) -&gt; sigma&#39;.</span>
<span class="sd">    :param absolute_sigma: See scipy.optimize.curve_fit.</span>
<span class="sd">    :param check_finite: See scipy.optimize.curve_fit.</span>
<span class="sd">    :param bounds: See scipy.optimize.curve_fit.</span>
<span class="sd">    :param method: See scipy.optimize.curve_fit.</span>
<span class="sd">    :param jac: See scipy.optimize.curve_fit. Must not be callable if &#39;sigma&#39; is callable.</span>
<span class="sd">    :param full_output: See scipy.optimize.curve_fit.</span>
<span class="sd">    :param report: Whether to print the result of the fit.</span>
<span class="sd">    :param kwargs: See scipy.optimize.curve_fit.</span>
<span class="sd">    :returns: popt, pcov. The optimal parameters and their covariance matrix. Additional output if full_output is True.</span>
<span class="sd">     See scipy.optimize.curve_fit.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">p0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># determine number of parameters by inspecting the function</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">_getfullargspec</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">args</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unable to determine number of fit parameters.&quot;</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">p0</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">p0</span><span class="o">.</span><span class="n">size</span>

    <span class="k">if</span> <span class="n">p0_fixed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">p0_fixed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p0_fixed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">p0_fixed</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bounds</span><span class="p">,</span> <span class="n">Bounds</span><span class="p">):</span>
        <span class="n">lb</span><span class="p">,</span> <span class="n">ub</span> <span class="o">=</span> <span class="n">bounds</span><span class="o">.</span><span class="n">lb</span><span class="p">,</span> <span class="n">bounds</span><span class="o">.</span><span class="n">ub</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lb</span><span class="p">,</span> <span class="n">ub</span> <span class="o">=</span> <span class="n">prepare_bounds</span><span class="p">(</span><span class="n">bounds</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="n">_initialize_feasible</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">ub</span><span class="p">)</span>

    <span class="c1"># Truncate p0, bounds and func to use free parameters only.</span>
    <span class="n">p0_free</span> <span class="o">=</span> <span class="n">p0</span><span class="p">[</span><span class="o">~</span><span class="n">p0_fixed</span><span class="p">]</span>
    <span class="n">lb</span><span class="p">,</span> <span class="n">ub</span> <span class="o">=</span> <span class="n">lb</span><span class="p">[</span><span class="o">~</span><span class="n">p0_fixed</span><span class="p">],</span> <span class="n">ub</span><span class="p">[</span><span class="o">~</span><span class="n">p0_fixed</span><span class="p">]</span>
    <span class="n">func</span> <span class="o">=</span> <span class="n">_wrap_func_pars</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p0_fixed</span><span class="p">)</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">ub</span><span class="p">)</span>

    <span class="n">bounded_problem</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">((</span><span class="n">lb</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ub</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">bounded_problem</span><span class="p">:</span>
            <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;trf&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;lm&#39;</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;lm&#39;</span> <span class="ow">and</span> <span class="n">bounded_problem</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Method &#39;lm&#39; only works for unconstrained problems. &quot;</span>
                         <span class="s2">&quot;Use &#39;trf&#39; or &#39;dogbox&#39; instead.&quot;</span><span class="p">)</span>

    <span class="c1"># optimization may produce garbage for float32 inputs, cast them to float64</span>

    <span class="c1"># NaNs cannot be handled</span>
    <span class="k">if</span> <span class="n">check_finite</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray_chkfinite</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
        <span class="c1"># &#39;x&#39; is passed straight to the user-defined &#39;f&#39;, so allow</span>
        <span class="c1"># non-array_like &#39;x&#39;.</span>
        <span class="k">if</span> <span class="n">check_finite</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray_chkfinite</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">y</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;y&#39; must not be empty!&quot;</span><span class="p">)</span>

    <span class="c1"># Determine type of sigma</span>
    <span class="k">if</span> <span class="n">sigma</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">sigma</span><span class="p">):</span>
            <span class="n">transform</span> <span class="o">=</span> <span class="n">_wrap_func_sigma</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p0_fixed</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>

            <span class="c1"># if 1-D, sigma are errors, define transform = 1/sigma</span>
            <span class="k">if</span> <span class="n">sigma</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">size</span><span class="p">,):</span>
                <span class="n">transform</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">sigma</span>
            <span class="c1"># if 2-D, sigma is the covariance matrix,</span>
            <span class="c1"># define transform = L such that L L^T = C</span>
            <span class="k">elif</span> <span class="n">sigma</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># scipy.linalg.cholesky requires lower=True to return L L^T = A</span>
                    <span class="n">transform</span> <span class="o">=</span> <span class="n">cholesky</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">LinAlgError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;sigma&#39; must be positive definite.&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;sigma&#39; has incorrect shape.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">func</span> <span class="o">=</span> <span class="n">_wrap_func</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">transform</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">jac</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">sigma</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;jac&#39; must not be callable if &#39;sigma&#39; is callable.&quot;</span><span class="p">)</span>
        <span class="n">jac</span> <span class="o">=</span> <span class="n">_wrap_jac</span><span class="p">(</span><span class="n">jac</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">transform</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">jac</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;lm&#39;</span><span class="p">:</span>
        <span class="n">jac</span> <span class="o">=</span> <span class="s1">&#39;2-point&#39;</span>

    <span class="k">if</span> <span class="s1">&#39;args&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="c1"># The specification for the model function &#39;f&#39; does not support</span>
        <span class="c1"># additional arguments. Refer to the &#39;curve_fit&#39; docstring for</span>
        <span class="c1"># acceptable call signatures of &#39;f&#39;.</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;args&#39; is not a supported keyword argument.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;lm&#39;</span><span class="p">:</span>
        <span class="c1"># if y.size == 1, this might be used for broadcast.</span>
        <span class="k">if</span> <span class="n">y</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="n">y</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The number of func parameters=</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> must not exceed the number of data points=</span><span class="si">{</span><span class="n">y</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">leastsq</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">p0_free</span><span class="p">,</span> <span class="n">Dfun</span><span class="o">=</span><span class="n">jac</span><span class="p">,</span> <span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span><span class="p">,</span> <span class="n">infodict</span><span class="p">,</span> <span class="n">errmsg</span><span class="p">,</span> <span class="n">ier</span> <span class="o">=</span> <span class="n">res</span>
        <span class="n">ysize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">infodict</span><span class="p">[</span><span class="s1">&#39;fvec&#39;</span><span class="p">])</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">infodict</span><span class="p">[</span><span class="s1">&#39;fvec&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ier</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Optimal parameters not found: &quot;</span> <span class="o">+</span> <span class="n">errmsg</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Rename maxfev (leastsq) to max_nfev (least_squares), if specified.</span>
        <span class="k">if</span> <span class="s1">&#39;max_nfev&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;max_nfev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;maxfev&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">least_squares</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">p0_free</span><span class="p">,</span> <span class="n">jac</span><span class="o">=</span><span class="n">jac</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Optimal parameters not found: &quot;</span> <span class="o">+</span> <span class="n">res</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>

        <span class="n">infodict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">nfev</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">nfev</span><span class="p">,</span> <span class="n">fvec</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">fun</span><span class="p">)</span>
        <span class="n">ier</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">status</span>
        <span class="n">errmsg</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">message</span>

        <span class="n">ysize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">fun</span><span class="p">)</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">res</span><span class="o">.</span><span class="n">cost</span>  <span class="c1"># res.cost is half sum of squares!</span>
        <span class="n">popt</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>

        <span class="c1"># Do Moore-Penrose inverse discarding zero singular values.</span>
        <span class="c1"># noinspection PyTupleAssignmentBalance</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">vt</span> <span class="o">=</span> <span class="n">svd</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">jac</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">jac</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">s</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">]</span>
        <span class="n">vt</span> <span class="o">=</span> <span class="n">vt</span><span class="p">[:</span><span class="n">s</span><span class="o">.</span><span class="n">size</span><span class="p">]</span>
        <span class="n">pcov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vt</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="n">s</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">vt</span><span class="p">)</span>

    <span class="n">warn_cov</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">s_sq</span> <span class="o">=</span> <span class="n">cost</span> <span class="o">/</span> <span class="p">(</span><span class="n">ysize</span> <span class="o">-</span> <span class="n">p0_free</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> <span class="k">if</span> <span class="n">ysize</span> <span class="o">&gt;</span> <span class="n">p0_free</span><span class="o">.</span><span class="n">size</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="k">if</span> <span class="n">pcov</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># indeterminate covariance</span>
        <span class="n">pcov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">popt</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">popt</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">pcov</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
        <span class="n">warn_cov</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">absolute_sigma</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">s_sq</span><span class="p">):</span>
            <span class="n">pcov</span> <span class="o">=</span> <span class="n">pcov</span> <span class="o">*</span> <span class="n">s_sq</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pcov</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
            <span class="n">warn_cov</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">popt_ret</span><span class="p">,</span> <span class="n">pcov_ret</span> <span class="o">=</span> <span class="n">p0</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">p0</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">p0</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">popt_ret</span><span class="p">[</span><span class="o">~</span><span class="n">p0_fixed</span><span class="p">]</span> <span class="o">=</span> <span class="n">popt</span>
    <span class="n">pcov_mask</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">p0_fixed</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">p0_fixed</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
    <span class="n">pcov_ret</span><span class="p">[</span><span class="n">pcov_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">pcov</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">report</span><span class="p">:</span>
        <span class="n">digits</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">size</span><span class="p">))))</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">printh</span><span class="p">(</span><span class="s2">&quot;curve_fit result:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">fix</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">popt_ret</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">pcov_ret</span><span class="p">)),</span> <span class="n">p0_fixed</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">digits</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2"> +/- </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="s1">&#39;fixed&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">fix</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;free&#39;</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;red. chi2: </span><span class="si">{</span><span class="n">s_sq</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">warn_cov</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Covariance of the parameters could not be estimated&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">OptimizeWarning</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">full_output</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">popt_ret</span><span class="p">,</span> <span class="n">pcov_ret</span><span class="p">,</span> <span class="n">infodict</span><span class="p">,</span> <span class="n">errmsg</span><span class="p">,</span> <span class="n">ier</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">popt_ret</span><span class="p">,</span> <span class="n">pcov_ret</span></div>


<span class="k">def</span> <span class="nf">_mass_factor_array</span><span class="p">(</span><span class="n">m0</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m0_d</span><span class="p">,</span> <span class="n">m1_d</span><span class="p">):</span>
    <span class="n">m_rel</span> <span class="o">=</span> <span class="n">m0</span> <span class="o">-</span> <span class="n">m1</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">m_rel</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">m_rel</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    
    <span class="n">mu</span> <span class="o">=</span> <span class="n">m0</span> <span class="o">*</span> <span class="n">m1</span> <span class="o">/</span> <span class="n">m_rel</span>
    <span class="n">mu_d</span> <span class="o">=</span> <span class="p">((</span><span class="n">mu</span> <span class="o">/</span> <span class="n">m0</span> <span class="o">-</span> <span class="n">mu</span> <span class="o">/</span> <span class="n">m_rel</span><span class="p">)</span> <span class="o">*</span> <span class="n">m0_d</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">mu_d</span> <span class="o">+=</span> <span class="p">((</span><span class="n">mu</span> <span class="o">/</span> <span class="n">m1</span> <span class="o">+</span> <span class="n">mu</span> <span class="o">/</span> <span class="n">m_rel</span><span class="p">)</span> <span class="o">*</span> <span class="n">m1_d</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">mu_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mu_d</span><span class="p">)</span>

    <span class="n">mu</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="n">mu_d</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">mu</span><span class="p">,</span> <span class="n">mu_d</span>


<div class="viewcode-block" id="King"><a class="viewcode-back" href="../../../qspec.html#qspec.analyze.King">[docs]</a><span class="k">class</span> <span class="nc">King</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">:</span> <span class="n">array_iter</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="n">array_iter</span><span class="p">,</span> <span class="n">x_abs</span><span class="p">:</span> <span class="n">array_iter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">subtract_electrons</span><span class="p">:</span> <span class="n">scalar</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">,</span> <span class="n">element_label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param a: An iterable of the mass numbers of the considered isotopes with shape (k, ),</span>
<span class="sd">         where k is the number of isotopes.</span>
<span class="sd">        :param m: The masses and their uncertainties of the isotopes &#39;a&#39; (u). &#39;m&#39; must have shape (k, 2).</span>
<span class="sd">        :param x_abs: The absolute values of the data vectors and their uncertainties</span>
<span class="sd">         corresponding to the mass numbers &#39;a&#39;. If given, the &#39;x&#39; and &#39;y&#39; parameters can be omitted when fitting</span>
<span class="sd">         (in &#39;fit&#39; and &#39;fit_nd&#39;) and is determined automatically as the difference between the mass numbers &#39;a&#39;</span>
<span class="sd">         and &#39;a_ref&#39;. Must have shape (k, n, 2) where n is the number of dimensions of the king plot.</span>
<span class="sd">        :param subtract_electrons: The number of electron masses that should be subtracted from the specified isotope</span>
<span class="sd">         masses. &#39;subtract_electrons&#39; does not have to be an integer if the ionization energy must be considered.</span>
<span class="sd">        :param n_samples: The number of generated samples for the monte-carlo routines.</span>
<span class="sd">        :param element_label: The label of the element to enhance the printed and plotted information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">))</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The given mass numbers must be unique.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_abs</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">asarray_optional</span><span class="p">(</span><span class="n">x_abs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subtract_electrons</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">subtract_electrons</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">element_label</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">element_label</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">element_label</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_abs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_abs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m_sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m_sub</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subtract_electrons</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">me_u</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m_sub</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">subtract_electrons</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">me_u_d</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m_mod</span> <span class="o">=</span> <span class="n">_mass_factor_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m_sub</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">m_sub</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">m_sub</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">m_sub</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m_mod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m_mod</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">nd</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_fit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_ref</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_mod</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cov</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">popt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcov</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># noinspection PyUnresolvedReferences</span>
    <span class="k">def</span> <span class="nf">_get_i</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">a_ref</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">_a</span><span class="p">)</span> <span class="k">for</span> <span class="n">_a</span> <span class="ow">in</span> <span class="n">a</span><span class="p">])</span>
        <span class="n">i_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">_a</span><span class="p">)</span> <span class="k">for</span> <span class="n">_a</span> <span class="ow">in</span> <span class="n">a_ref</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">i</span><span class="p">,</span> <span class="n">i_ref</span>

    <span class="k">def</span> <span class="nf">_sample_xmod</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">i_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_i</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_fit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_ref</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">m_sub</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">m_sub</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m_sub</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">],</span>
                     <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

        <span class="n">m_mod</span> <span class="o">=</span> <span class="n">_mass_factor_array</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">m</span><span class="p">[</span><span class="n">i_ref</span><span class="p">],</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">x_mod</span> <span class="o">=</span> <span class="n">m_mod</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">x</span>
        <span class="k">return</span> <span class="n">x_mod</span>

    <span class="k">def</span> <span class="nf">_cov_mc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :returns: The covariance matrices of the data vectors by sampling the data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x_mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_xmod</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">x_mod_i</span><span class="p">)</span> <span class="k">for</span> <span class="n">x_mod_i</span> <span class="ow">in</span> <span class="n">x_mod</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_corr_mc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :returns: The correlation coefficients of the modified x- and y-data points by sampling the data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x_mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_xmod</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">x_mod_i</span><span class="p">)</span> <span class="k">for</span> <span class="n">x_mod_i</span> <span class="ow">in</span> <span class="n">x_mod</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_cov</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">i_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_i</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_fit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_ref</span><span class="p">)</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">m_mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m_mod</span><span class="p">[</span><span class="n">i_ref</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">cov_x</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">_x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">_m_mod</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">**</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">_m_mod</span><span class="p">,</span> <span class="n">_x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">m_mod</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)]</span>
        <span class="n">jac</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">_x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">_m_mod</span><span class="p">[</span><span class="mi">0</span><span class="p">]))],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
               <span class="k">for</span> <span class="n">_m_mod</span><span class="p">,</span> <span class="n">_x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">m_mod</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">_jac</span> <span class="o">@</span> <span class="p">(</span><span class="n">_cov_x</span> <span class="o">@</span> <span class="n">_jac</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="k">for</span> <span class="n">_jac</span><span class="p">,</span> <span class="n">_cov_x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">jac</span><span class="p">,</span> <span class="n">cov_x</span><span class="p">)])</span>

    <span class="k">def</span> <span class="nf">_corr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">_cov</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">_cov</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">_cov</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:])</span> <span class="k">for</span> <span class="n">_cov</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cov</span><span class="p">()])</span>

<div class="viewcode-block" id="King.fit"><a class="viewcode-back" href="../../../qspec.html#qspec.analyze.King.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">:</span> <span class="n">array_iter</span><span class="p">,</span> <span class="n">a_ref</span><span class="p">:</span> <span class="n">array_iter</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">array_iter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">array_iter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">xy</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="n">york_fit</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="n">scalar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">find_alpha</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">show</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param a: An Iterable of the mass numbers of the used isotopes.</span>
<span class="sd">        :param a_ref: An Iterable of the mass numbers of the used reference isotopes.</span>
<span class="sd">        :param x: The x-values and their uncertainties of the King-fit to be performed. If &#39;mode&#39; is &quot;radii&quot;,</span>
<span class="sd">         this must contain the differences of mean square nuclear charge radii or the Lambda-factor.</span>
<span class="sd">         &#39;x&#39; must have shape (len(a), 2). Units: (fm ** 2) or (MHz).</span>
<span class="sd">        :param y: The isotope shifts and their uncertainties of the King-fit to be performed.</span>
<span class="sd">         &#39;y&#39; must have shape (len(a), 2). If None, &#39;y&#39; is tried to be inherited from &#39;self.f&#39;. Units: (MHz).</span>
<span class="sd">        :param xy: A 2-tuple of indices (ix, iy) which select the axes to use for the King-fit from &#39;King.x_abs&#39;</span>
<span class="sd">         if x or y is not specified. The default value is (0, 1), fitting the second against the first axis.</span>
<span class="sd">        :param func: The fitting routine. Must be one of {&#39;york_fit&#39; (default), &#39;linear_fit&#39;, &#39;linear_monte_carlo&#39;}.</span>
<span class="sd">        :param alpha: An x-axis offset to reduce the correlation coefficient between the y-intercept and the slope.</span>
<span class="sd">         Unit: (u fm ** 2) or (u MHz).</span>
<span class="sd">        :param find_alpha: Whether to search for the best &#39;alpha&#39;. Uses the given &#39;alpha&#39; as a starting point.</span>
<span class="sd">         May not give the desired result if &#39;alpha&#39; was initialized to far from its optimal value.</span>
<span class="sd">        :param show: Whether to plot the fit result.</span>
<span class="sd">        :param kwargs: Additional keyword arguments are passed to &#39;self.plot&#39;.</span>
<span class="sd">        :returns: A list of results as defined by the routine &#39;linear_alpha&#39;:</span>
<span class="sd">         a, b, sigma_a, sigma_b, corr_ab, alpha. The best y-intercept and slope,</span>
<span class="sd">         their respective 1-sigma uncertainties, their correlation coefficient and the used alpha.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nd</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_fit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">a_ref</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">i_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_i</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_fit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_ref</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">xy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xy</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">a_fit</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_abs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_abs</span><span class="p">[</span><span class="n">i_ref</span><span class="p">,</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_abs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_abs</span><span class="p">[</span><span class="n">i_ref</span><span class="p">,</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_abs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_abs</span><span class="p">[</span><span class="n">i_ref</span><span class="p">,</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_abs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_abs</span><span class="p">[</span><span class="n">i_ref</span><span class="p">,</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="n">m_mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m_mod</span><span class="p">[</span><span class="n">i_ref</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">m_mod</span> <span class="o">=</span> <span class="n">m_mod</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">x_mod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">m_mod</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">straight_x_std</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">m_mod</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">],</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">m_mod</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">],</span> <span class="mf">0.</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_mod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_mod</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">corr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_corr</span><span class="p">()[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">popt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcov</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">linear_alpha_fit</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x_mod</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_mod</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">sigma_x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x_mod</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">sigma_y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x_mod</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">corr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">corr</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">func</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">find_alpha</span><span class="o">=</span><span class="n">find_alpha</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">popt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcov</span></div>

<div class="viewcode-block" id="King.fit_nd"><a class="viewcode-back" href="../../../qspec.html#qspec.analyze.King.fit_nd">[docs]</a>    <span class="k">def</span> <span class="nf">fit_nd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">:</span> <span class="n">array_iter</span><span class="p">,</span> <span class="n">a_ref</span><span class="p">:</span> <span class="n">array_iter</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">array_iter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">optimize_cov</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">linear_nd_fit</span><span class="p">,</span>
               <span class="n">show</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param a: An Iterable of the mass numbers of the used isotopes with shape (k, ).</span>
<span class="sd">        :param a_ref: An Iterable of the mass numbers of the used reference isotopes with shape (k, ).</span>
<span class="sd">        :param x: The x data as an iterable of vectors with uncertainties of shape (k, n, 2), where k is the</span>
<span class="sd">         number of data points and n is the number of dimensions of each point.</span>
<span class="sd">        :param axis: The axis to use for the parametrization. For example, a King plot with the isotope shifts</span>
<span class="sd">         of two transitions [&#39;D1&#39;, &#39;D2&#39;] yields the slope F_D2 / F_D1 if &#39;axis&#39; == 0.</span>
<span class="sd">        :param optimize_cov: If True, the origin vector of the straight is optimized to yield the smallest covariances.</span>
<span class="sd">        :param func: The fitting routine. Must be one of {&#39;linear_nd_fit&#39;, &#39;linear_nd_monte_carlo&#39;}.</span>
<span class="sd">        :param show: Whether to plot the fit result.</span>
<span class="sd">        :param kwargs: Additional keyword arguments are passed to &#39;func&#39; and &#39;self.plot_nd&#39;.</span>
<span class="sd">        :returns: popt, pcov. The optimized parameters and their covariances. The resulting shapes are (2n, )</span>
<span class="sd">         and (2n, 2n).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nd</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_fit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">a_ref</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">i_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_i</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_fit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_ref</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">a_fit</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_abs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_abs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_abs</span><span class="p">[</span><span class="n">i_ref</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_abs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_abs</span><span class="p">[</span><span class="n">i_ref</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="n">m_mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m_mod</span><span class="p">[</span><span class="n">i_ref</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">m_mod</span> <span class="o">=</span> <span class="n">m_mod</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">x_mod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">m_mod</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">straight_x_std</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">m_mod</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">],</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">m_mod</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">],</span> <span class="mf">0.</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_mod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_mod</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">funcs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;linear_nd_fit&#39;</span><span class="p">,</span> <span class="s1">&#39;linear_nd_monte_carlo&#39;</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">func</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">func</span><span class="se">\&#39;</span><span class="s1"> must be in </span><span class="si">{</span><span class="n">funcs</span><span class="si">}</span><span class="s1"> but is </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">.&#39;</span><span class="p">)</span>
            <span class="n">func</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cov</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">popt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcov</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> \
            <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_mod</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">cov</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cov</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">optimize_cov</span><span class="o">=</span><span class="n">optimize_cov</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">popt</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span>

        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">popt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcov</span></div>

    <span class="k">def</span> <span class="nf">_get_gradient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">m_mod</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">popt</span><span class="o">.</span><span class="n">size</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">_a</span><span class="p">,</span> <span class="n">_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">popt</span><span class="p">[:</span><span class="n">dim</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">popt</span><span class="p">[</span><span class="n">dim</span><span class="p">:]</span>
        <span class="n">br</span> <span class="o">=</span> <span class="n">_b</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">/</span> <span class="n">_b</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">_a</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">/</span> <span class="n">m_mod</span><span class="p">)</span> <span class="o">/</span> <span class="n">_b</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span>

        <span class="n">yi</span> <span class="o">=</span> <span class="p">[</span><span class="n">br</span><span class="p">]</span>
        <span class="n">ai</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="n">axis</span> <span class="ow">or</span> <span class="n">index</span> <span class="o">!=</span> <span class="n">d</span> <span class="o">!=</span> <span class="n">axis</span>
              <span class="k">else</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">m_mod</span> <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="n">index</span> <span class="k">else</span> <span class="o">-</span><span class="n">br</span> <span class="o">/</span> <span class="n">m_mod</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">)]</span>
        <span class="n">bi</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="n">axis</span> <span class="ow">or</span> <span class="n">index</span> <span class="o">!=</span> <span class="n">d</span> <span class="o">!=</span> <span class="n">axis</span> <span class="k">else</span> <span class="p">(</span><span class="n">t</span> <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="n">index</span> <span class="k">else</span> <span class="o">-</span><span class="n">br</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">)]</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="n">axis</span> <span class="k">else</span> <span class="p">(</span><span class="n">br</span> <span class="o">*</span> <span class="n">_a</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">-</span> <span class="n">_a</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="o">/</span> <span class="n">m_mod</span> <span class="o">**</span> <span class="mi">2</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ai</span> <span class="o">+</span> <span class="n">bi</span> <span class="o">+</span> <span class="n">mu</span> <span class="o">+</span> <span class="n">yi</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_gradient_mod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">popt</span><span class="o">.</span><span class="n">size</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">_a</span><span class="p">,</span> <span class="n">_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">popt</span><span class="p">[:</span><span class="n">dim</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">popt</span><span class="p">[</span><span class="n">dim</span><span class="p">:]</span>
        <span class="n">br</span> <span class="o">=</span> <span class="n">_b</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">/</span> <span class="n">_b</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">_a</span><span class="p">[</span><span class="n">axis</span><span class="p">])</span> <span class="o">/</span> <span class="n">_b</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span>

        <span class="n">yi</span> <span class="o">=</span> <span class="p">[</span><span class="n">br</span><span class="p">]</span>
        <span class="n">ai</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="n">axis</span> <span class="ow">or</span> <span class="n">index</span> <span class="o">!=</span> <span class="n">d</span> <span class="o">!=</span> <span class="n">axis</span> <span class="k">else</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="n">index</span> <span class="k">else</span> <span class="o">-</span><span class="n">br</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">)]</span>
        <span class="n">bi</span> <span class="o">=</span> <span class="p">[</span><span class="n">_ai</span> <span class="o">*</span> <span class="n">t</span> <span class="k">for</span> <span class="n">_ai</span> <span class="ow">in</span> <span class="n">ai</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ai</span> <span class="o">+</span> <span class="n">bi</span> <span class="o">+</span> <span class="n">yi</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

<div class="viewcode-block" id="King.get_unmodified"><a class="viewcode-back" href="../../../qspec.html#qspec.analyze.King.get_unmodified">[docs]</a>    <span class="k">def</span> <span class="nf">get_unmodified</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">:</span> <span class="n">array_iter</span><span class="p">,</span> <span class="n">a_ref</span><span class="p">:</span> <span class="n">array_iter</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">array_iter</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                       <span class="n">show</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param a: An Iterable of mass numbers corresponding to the isotopes of the given &#39;y&#39; values.</span>
<span class="sd">        :param a_ref: An Iterable of mass numbers corresponding to reference isotopes of the given &#39;y&#39; values.</span>
<span class="sd">        :param x: The unmodified input values of the given mass numbers. Must have shape (len(a), 2).</span>
<span class="sd">        :param axis: The axis of the input values.</span>
<span class="sd">        :param show: Whether to draw the King plot with the specified values.</span>
<span class="sd">        :param kwargs: Additional keyword arguments are passed to &#39;self.plot&#39;.</span>
<span class="sd">        :returns: The unmodified x values calculated with the fit results and the given &#39;y&#39; values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">popt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;There are no results yet. Please use one of the fitting options {</span><span class="se">\&#39;</span><span class="s1">fit</span><span class="se">\&#39;</span><span class="s1"> or </span><span class="se">\&#39;</span><span class="s1">fit_nd</span><span class="se">\&#39;</span><span class="s1">}.&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">nd</span><span class="p">:</span>
            <span class="n">indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">indexes</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis</span>
            <span class="n">mask</span> <span class="o">+=</span> <span class="n">indexes</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">mask</span>

            <span class="n">pcov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcov</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">popt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">popt</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="mf">1.</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pcov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pcov</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">mask</span><span class="p">)]</span> <span class="o">=</span> <span class="n">pcov</span>

        <span class="n">a</span><span class="p">,</span> <span class="n">a_ref</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">a_ref</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">i_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_i</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a_ref</span><span class="p">)</span>

        <span class="n">dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">popt</span><span class="o">.</span><span class="n">size</span> <span class="o">//</span> <span class="mi">2</span>

        <span class="n">_a</span><span class="p">,</span> <span class="n">_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">popt</span><span class="p">[:</span><span class="n">dim</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">popt</span><span class="p">[</span><span class="n">dim</span><span class="p">:]</span>

        <span class="n">m_mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m_mod</span><span class="p">[</span><span class="n">i_ref</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">x_mod</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">m_mod</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">x_mod_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">m_mod</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">m_mod</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Uncertainty propagation for the modified data including covariances (for plot only).</span>
        <span class="n">jac</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_gradient_mod</span><span class="p">(</span><span class="n">_x_mod</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">)])</span> <span class="k">for</span> <span class="n">_x_mod</span> <span class="ow">in</span> <span class="n">x_mod</span><span class="p">]</span>
        <span class="n">cov_x</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">block</span><span class="p">([[</span><span class="bp">self</span><span class="o">.</span><span class="n">pcov</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dim</span><span class="p">,</span> <span class="mi">1</span><span class="p">))],</span>
                           <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dim</span><span class="p">)),</span> <span class="n">_x_mod_d</span> <span class="o">**</span> <span class="mi">2</span><span class="p">]])</span> <span class="k">for</span> <span class="n">_x_mod_d</span> <span class="ow">in</span> <span class="n">x_mod_d</span><span class="p">]</span>
        <span class="n">cov_mod</span> <span class="o">=</span> <span class="p">[</span><span class="n">_jac</span> <span class="o">@</span> <span class="p">(</span><span class="n">_cov_x</span> <span class="o">@</span> <span class="n">_jac</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="k">for</span> <span class="n">_jac</span><span class="p">,</span> <span class="n">_cov_x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">jac</span><span class="p">,</span> <span class="n">cov_x</span><span class="p">)]</span>
        <span class="n">corr_mod</span> <span class="o">=</span> <span class="p">[</span><span class="n">_cov</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">_cov</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">_cov</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:])</span> <span class="k">for</span> <span class="n">_cov</span> <span class="ow">in</span> <span class="n">cov_mod</span><span class="p">]</span>

        <span class="n">y_mod</span> <span class="o">=</span> <span class="n">_a</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">_b</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">_b</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_mod</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="n">_a</span><span class="p">[</span><span class="n">axis</span><span class="p">])</span>

        <span class="c1"># Calculate the unmodified values including covariances ...</span>
        <span class="n">jac</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_gradient</span><span class="p">(</span><span class="n">_x</span><span class="p">,</span> <span class="n">_m_mod</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">)])</span>
               <span class="k">for</span> <span class="n">_m_mod</span><span class="p">,</span> <span class="n">_x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">m_mod</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])]</span>
        <span class="n">cov_x</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">block</span><span class="p">([[</span><span class="bp">self</span><span class="o">.</span><span class="n">pcov</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dim</span><span class="p">,</span> <span class="mi">2</span><span class="p">))],</span>
                           <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dim</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="n">_m_mod_d</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">_x_d</span> <span class="o">**</span> <span class="mi">2</span><span class="p">])]])</span>
                 <span class="k">for</span> <span class="n">_m_mod_d</span><span class="p">,</span> <span class="n">_x_d</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">m_mod</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])]</span>
        <span class="n">cov_stat</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">block</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dim</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dim</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dim</span><span class="p">,</span> <span class="mi">2</span><span class="p">))],</span>
                              <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dim</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="n">_m_mod_d</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">_x_d</span> <span class="o">**</span> <span class="mi">2</span><span class="p">])]])</span>
                    <span class="k">for</span> <span class="n">_m_mod_d</span><span class="p">,</span> <span class="n">_x_d</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">m_mod</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])]</span>

        <span class="c1"># ... with and without uncertainties of fit parameters.</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">_jac</span> <span class="o">@</span> <span class="p">(</span><span class="n">_cov_x</span> <span class="o">@</span> <span class="n">_jac</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="k">for</span> <span class="n">_jac</span><span class="p">,</span> <span class="n">_cov_x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">jac</span><span class="p">,</span> <span class="n">cov_x</span><span class="p">)])</span>
        <span class="n">cov_stat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">_jac</span> <span class="o">@</span> <span class="p">(</span><span class="n">_cov_stat</span> <span class="o">@</span> <span class="n">_jac</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="k">for</span> <span class="n">_jac</span><span class="p">,</span> <span class="n">_cov_stat</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">jac</span><span class="p">,</span> <span class="n">cov_stat</span><span class="p">)])</span>

        <span class="n">y</span> <span class="o">=</span> <span class="n">y_mod</span> <span class="o">/</span> <span class="n">m_mod</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">add_xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[[</span><span class="n">_y_mod</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">_cov</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">]),</span>
                                 <span class="n">_y_mod</span><span class="p">[</span><span class="n">d</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">_cov</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">d</span><span class="p">]),</span> <span class="n">_corr</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">,</span> <span class="n">d</span><span class="p">]]</span>
                                <span class="k">for</span> <span class="n">_y_mod</span><span class="p">,</span> <span class="n">_cov</span><span class="p">,</span> <span class="n">_corr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">y_mod</span><span class="p">,</span> <span class="n">cov_mod</span><span class="p">,</span> <span class="n">corr_mod</span><span class="p">)]</span>
                               <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span> <span class="k">if</span> <span class="n">d</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">])</span>
            <span class="n">add_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">a_ref</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">nd</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">popt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">popt</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pcov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcov</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">mask</span><span class="p">)]</span>
                <span class="n">add_xy</span> <span class="o">=</span> <span class="n">add_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">add_xy</span><span class="o">=</span><span class="n">add_xy</span><span class="p">,</span> <span class="n">add_a</span><span class="o">=</span><span class="n">add_a</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">y</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">cov_stat</span></div>

    <span class="c1"># def _get_unmodified_mc(self, a: array_iter, a_ref: array_iter, x: array_iter, axis: int = 0,</span>
    <span class="c1">#                        show: bool = False, **kwargs):</span>
    <span class="c1">#     a, a_ref, x = np.asarray(a), np.asarray(a_ref), np.asarray(x)</span>
    <span class="c1">#     i, i_ref = self._get_i(a, a_ref)</span>
    <span class="c1">#</span>
    <span class="c1">#     popt_s = multivariate_normal.rvs(mean=self.popt, cov=self.pcov, size=self.n_samples).T</span>
    <span class="c1">#     if axis == 0:</span>
    <span class="c1">#         _a, _b = self.popt[0], self.popt[1]</span>
    <span class="c1">#         _a_s, _b_s = popt_s[0], popt_s[1]</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         _a, _b = -self.popt[0] / self.popt[1], 1 / self.popt[1]</span>
    <span class="c1">#         _a_s, _b_s = -popt_s[0] / popt_s[1], 1 / popt_s[1]</span>
    <span class="c1">#</span>
    <span class="c1">#     m_s = norm.rvs(loc=self.m[:, 0], scale=self.m[:, 1], size=(self.n_samples, self.m.shape[0])).T</span>
    <span class="c1">#     m_mod_s = _mass_factor_array(m_s[i], m_s[i_ref], 0., 0.)[0]</span>
    <span class="c1">#</span>
    <span class="c1">#     x_s = norm.rvs(loc=x[:, 0], scale=x[:, 1], size=(self.n_samples, x.shape[0])).T</span>
    <span class="c1">#     x_mod_s = m_mod_s * x_s</span>
    <span class="c1">#</span>
    <span class="c1">#     y_mod_s = straight(x_mod_s, _a_s, _b_s)</span>
    <span class="c1">#     y_s = y_mod_s / m_mod_s</span>
    <span class="c1">#</span>
    <span class="c1">#     y_mod_stat_s = straight(x_mod_s, _a, _b)</span>
    <span class="c1">#     y_stat_s = y_mod_stat_s / m_mod_s  # For non-fit uncertainties only</span>
    <span class="c1">#</span>
    <span class="c1">#     x_mod = np.array([np.mean(x_mod_s, axis=-1), np.std(x_mod_s, ddof=1, axis=-1)]).T</span>
    <span class="c1">#     y_mod = np.array([np.mean(y_mod_s, axis=-1), np.std(y_mod_s, ddof=1, axis=-1)]).T</span>
    <span class="c1">#     corr_mod = np.array([np.corrcoef(_x, _y)[0, 1] for _x, _y in zip(x_mod_s, y_mod_s)])</span>
    <span class="c1">#</span>
    <span class="c1">#     y = np.mean(y_s, axis=-1)</span>
    <span class="c1">#     y_d = np.std(y_s, ddof=1, axis=-1)</span>
    <span class="c1">#     ys_d = np.std(y_stat_s, ddof=1, axis=-1)</span>
    <span class="c1">#</span>
    <span class="c1">#     if show:</span>
    <span class="c1">#         if axis == 0:</span>
    <span class="c1">#             add_xy = np.array([x_mod[:, 0], x_mod[:, 1], y_mod[:, 0], y_mod[:, 1], corr_mod]).T</span>
    <span class="c1">#         else:</span>
    <span class="c1">#             add_xy = np.array([y_mod[:, 0], y_mod[:, 1], x_mod[:, 0], x_mod[:, 1], corr_mod]).T</span>
    <span class="c1">#         add_a = np.array([a, a_ref]).T</span>
    <span class="c1">#         self.plot(add_xy=add_xy, add_a=add_a, **kwargs)</span>
    <span class="c1">#</span>
    <span class="c1">#     return y, y_d, ys_d</span>
    <span class="c1">#</span>
    <span class="c1"># def _get_unmodified_nd_mc(self, a: array_iter, a_ref: array_iter, x: array_iter, axis: int = 0,</span>
    <span class="c1">#                           show: bool = False, **kwargs):</span>
    <span class="c1">#     a, a_ref, x = np.asarray(a), np.asarray(a_ref), np.asarray(x)</span>
    <span class="c1">#     i, i_ref = self._get_i(a, a_ref)</span>
    <span class="c1">#</span>
    <span class="c1">#     dim = self.popt.size // 2</span>
    <span class="c1">#     indexes = np.arange(2 * dim, dtype=int)</span>
    <span class="c1">#     mask = indexes == self.axis</span>
    <span class="c1">#     mask += indexes == dim + self.axis</span>
    <span class="c1">#     mask = ~mask</span>
    <span class="c1">#</span>
    <span class="c1">#     popt_s = multivariate_normal.rvs(mean=self.popt[mask], cov=self.pcov[np.ix_(mask, mask)], size=self.n_samples).T</span>
    <span class="c1">#     popt_s = np.insert(popt_s, [self.axis, dim + self.axis],</span>
    <span class="c1">#                        [np.full(self.n_samples, self.popt[self.axis]),</span>
    <span class="c1">#                         np.full(self.n_samples, self.popt[dim + self.axis])], axis=0)</span>
    <span class="c1">#</span>
    <span class="c1">#     m_s = norm.rvs(loc=self.m[:, 0], scale=self.m[:, 1], size=(self.n_samples, self.m.shape[0])).T</span>
    <span class="c1">#     m_mod_s = _mass_factor_array(m_s[i], m_s[i_ref], 0., 0.)[0]</span>
    <span class="c1">#</span>
    <span class="c1">#     x_s = norm.rvs(loc=x[:, 0], scale=x[:, 1], size=(self.n_samples, x.shape[0])).T</span>
    <span class="c1">#     x_mod_s = m_mod_s * x_s</span>
    <span class="c1">#</span>
    <span class="c1">#     t_s = (x_mod_s - popt_s[axis][None, :]) / popt_s[dim + axis][None, :]</span>
    <span class="c1">#     # t_s = (x_mod_s - self.popt[axis]) / self.popt[dim + axis]</span>
    <span class="c1">#     y_mod_s = popt_s[:dim][:, None, :] + t_s[None, :, :] * popt_s[dim:][:, None, :]</span>
    <span class="c1">#     y_s = y_mod_s / m_mod_s[None, :, :]</span>
    <span class="c1">#</span>
    <span class="c1">#     m_mod = _mass_factor_array(self.m[i, 0], self.m[i_ref, 0], self.m[i, 1], self.m[i_ref, 1])</span>
    <span class="c1">#     x_modt = np.array([m_mod[0] * x[:, 0], np.sqrt((m_mod[1] * x[:, 0]) ** 2 + (m_mod[0] * x[:, 1]) ** 2)]).T</span>
    <span class="c1">#</span>
    <span class="c1">#     x_mod = np.array([np.mean(y_mod_s[self.axis], axis=-1), np.std(y_mod_s[self.axis], ddof=1, axis=-1)]).T</span>
    <span class="c1">#     y_mod = np.array([np.array([np.mean(y_mod_s[d], axis=-1), np.std(y_mod_s[d], ddof=1, axis=-1)]).T</span>
    <span class="c1">#                       for d in range(dim) if d != self.axis])</span>
    <span class="c1">#     corr_mod = np.array([np.array([np.corrcoef(_x, _y)[0, 1] for _x, _y in zip(y_mod_s[self.axis], _y_mod_s)])</span>
    <span class="c1">#                          for d, _y_mod_s in enumerate(y_mod_s) if d != self.axis])</span>
    <span class="c1">#</span>
    <span class="c1">#     if show:</span>
    <span class="c1">#         add_xy = np.array([np.array([x_mod[:, 0], x_mod[:, 1], _y_mod[:, 0], _y_mod[:, 1], _corr_mod]).T</span>
    <span class="c1">#                            for _y_mod, _corr_mod in zip(y_mod, corr_mod)])</span>
    <span class="c1">#         add_a = np.array([a, a_ref]).T</span>
    <span class="c1">#         self.plot_nd(add_xy=add_xy, add_a=add_a, **kwargs)</span>

    <span class="k">def</span> <span class="nf">_plot_2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">sigma2d</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">scale</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">add_xy</span><span class="p">:</span> <span class="n">array_like</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">add_a</span><span class="p">:</span> <span class="n">array_like</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param mode: The mode of the King-fit. If mode=&#39;radii&#39;, the x-axis must contain the differences of</span>
<span class="sd">         mean square nuclear charge radii or the Lambda-factor. For every other value,</span>
<span class="sd">         the x-axis is assumed to be an isotope shift such that the slope corresponds to</span>
<span class="sd">         a field-shift ratio F(y_i) / F(x).</span>
<span class="sd">        :param sigma2d: Whether to draw the actual two-dimensional uncertainty bounds or the classical errorbars.</span>
<span class="sd">         The integer number corresponds to the number of drawn sigma regions.</span>
<span class="sd">        :param scale: Factors to scale the x and the y-axis.</span>
<span class="sd">        :param add_xy: Additional x and y data to plot. Must have shape (k, 5),</span>
<span class="sd">         where the additional k data points are arrays of the form [x, x_d, y, y_d, corr_xy].</span>
<span class="sd">        :param add_a: Additional mass numbers for the additional data. Must have shape (k, 2),</span>
<span class="sd">         where each row is a tuple [A, A_ref].</span>
<span class="sd">        :param font_dict: The font_dict passed to matplotlib.rc(&#39;font&#39;, font_dict).</span>
<span class="sd">        :param show: Whether to show the plot.</span>
<span class="sd">        :param kwargs: Additional keyword arguments.</span>
<span class="sd">        :returns: None. Generates a King-Plot based on the modified axes &#39;self.x_mod&#39; and &#39;self.y_mod&#39;</span>
<span class="sd">         as well as the fit results &#39;self.results&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">popt</span>
        <span class="n">sigma_a</span><span class="p">,</span> <span class="n">sigma_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pcov</span><span class="p">))</span>
        <span class="n">corr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcov</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma_a</span> <span class="o">*</span> <span class="n">sigma_b</span><span class="p">)</span>

        <span class="n">scale_x</span> <span class="o">=</span> <span class="mf">1e-3</span> <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">scale_y</span> <span class="o">=</span> <span class="mf">1e-3</span> <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">offset_str</span> <span class="o">=</span> <span class="s1">&#39; - </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">scale_x</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;x</span><span class="si">{}</span><span class="s1"> (mode=</span><span class="se">\&#39;</span><span class="s1">shifts</span><span class="se">\&#39;</span><span class="s1"> or =</span><span class="se">\&#39;</span><span class="s1">radii</span><span class="se">\&#39;</span><span class="s1"> for right x-label)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">offset_str</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;radii&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">scale_x</span> <span class="o">=</span> <span class="mf">1.</span>
            <span class="n">offset_str</span> <span class="o">=</span> <span class="s1">&#39; - </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">scale_x</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="n">xlabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\mu\,\delta\langle r^2\rangle^{A, A^\prime}&#39;</span> <span class="o">+</span> <span class="n">offset_str</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\quad(\mathrm</span><span class="si">{u}</span><span class="s1">\,\mathrm</span><span class="si">{fm}</span><span class="s1">^2)$&#39;</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;shifts&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">scale_x</span> <span class="o">=</span> <span class="mf">1e-3</span>
            <span class="n">offset_str</span> <span class="o">=</span> <span class="s1">&#39; - </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">scale_x</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="n">xlabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\mu\,\delta\nu_x^{A, A^\prime}&#39;</span> <span class="o">+</span> <span class="n">offset_str</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\quad(\mathrm{u\,GHz})$&#39;</span>

        <span class="k">if</span> <span class="n">sigma2d</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x_mod</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_x</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">x_mod</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale_y</span><span class="p">,</span> <span class="s1">&#39;k.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data&#39;</span><span class="p">)</span>
            <span class="n">draw_sigma2d</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x_mod</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_mod</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale_y</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">x_mod</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_mod</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">corr</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">sigma2d</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">add_xy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="n">add_xy</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_x</span><span class="p">,</span>
                         <span class="n">add_xy</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale_y</span><span class="p">,</span> <span class="s1">&#39;r.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data&#39;</span><span class="p">)</span>
                <span class="n">draw_sigma2d</span><span class="p">((</span><span class="n">add_xy</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_x</span><span class="p">,</span> <span class="n">add_xy</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale_y</span><span class="p">,</span>
                             <span class="n">add_xy</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale_x</span><span class="p">,</span> <span class="n">add_xy</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale_y</span><span class="p">,</span> <span class="n">add_xy</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">n</span><span class="o">=</span><span class="n">sigma2d</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s1">&#39;fmt&#39;</span><span class="p">:</span> <span class="s1">&#39;-r&#39;</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x_mod</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_mod</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale_y</span><span class="p">,</span>
                         <span class="n">xerr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x_mod</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale_x</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x_mod</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale_y</span><span class="p">,</span>
                         <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;k.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">add_xy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">((</span><span class="n">add_xy</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_x</span><span class="p">,</span> <span class="n">add_xy</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale_y</span><span class="p">,</span>
                             <span class="n">xerr</span><span class="o">=</span><span class="n">add_xy</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale_x</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">add_xy</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale_y</span><span class="p">,</span>
                             <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;r.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Add. Data&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_fit</span><span class="p">)):</span>
            <span class="n">pm</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span> <span class="k">if</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">1.</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x_mod</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_mod</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_x</span><span class="p">,</span>
                     <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_mod</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">pm</span> <span class="o">*</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_mod</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">scale_y</span><span class="p">,</span>
                     <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> - </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_fit</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_ref</span><span class="p">[</span><span class="n">j</span><span class="p">]),</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span> <span class="k">if</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;bottom&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">add_a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">add_xy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">add_xy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">pm</span> <span class="o">=</span> <span class="mf">1.</span> <span class="k">if</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mf">1.</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="n">add_xy</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">add_xy</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_x</span><span class="p">,</span>
                         <span class="p">(</span><span class="n">add_xy</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">pm</span> <span class="o">*</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">add_xy</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="n">scale_y</span><span class="p">,</span>
                         <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> - </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">add_a</span><span class="p">[</span><span class="n">j</span><span class="p">]),</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span> <span class="k">if</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;top&#39;</span><span class="p">)</span>

        <span class="n">min_x</span><span class="p">,</span> <span class="n">max_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_mod</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_mod</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">add_xy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">min_x</span><span class="p">,</span> <span class="n">max_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">min_x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">add_xy</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">max_x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">add_xy</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])])</span>
        <span class="n">x_cont</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">min_x</span> <span class="o">-</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span><span class="p">),</span> <span class="n">max_x</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span><span class="p">),</span> <span class="mi">1001</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_cont</span> <span class="o">*</span> <span class="n">scale_x</span><span class="p">,</span> <span class="n">straight</span><span class="p">(</span><span class="n">x_cont</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_y</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Fit&#39;</span><span class="p">)</span>
        <span class="n">y_min</span> <span class="o">=</span> <span class="n">straight</span><span class="p">(</span><span class="n">x_cont</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="n">straight_std</span><span class="p">(</span><span class="n">x_cont</span><span class="p">,</span> <span class="n">sigma_a</span><span class="p">,</span> <span class="n">sigma_b</span><span class="p">,</span> <span class="n">corr</span><span class="p">)</span>
        <span class="n">y_max</span> <span class="o">=</span> <span class="n">straight</span><span class="p">(</span><span class="n">x_cont</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="n">straight_std</span><span class="p">(</span><span class="n">x_cont</span><span class="p">,</span> <span class="n">sigma_a</span><span class="p">,</span> <span class="n">sigma_b</span><span class="p">,</span> <span class="n">corr</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x_cont</span> <span class="o">*</span> <span class="n">scale_x</span><span class="p">,</span> <span class="n">y_min</span> <span class="o">*</span> <span class="n">scale_y</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">*</span> <span class="n">scale_y</span><span class="p">,</span>
                         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">antialiased</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\mu\,\delta\nu_y^{A, A^\prime}\quad(\mathrm{u\,GHz})$&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">numpoints</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="King.plot"><a class="viewcode-back" href="../../../qspec.html#qspec.analyze.King.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">sigma2d</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">scale</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">add_xy</span><span class="p">:</span> <span class="n">array_like</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">add_a</span><span class="p">:</span> <span class="n">array_like</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">font_dict</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param mode: The mode of the King-fit. If mode=&#39;radii&#39;, the x-axis must contain the differences of</span>
<span class="sd">         mean square nuclear charge radii or the Lambda-factor. For every other value,</span>
<span class="sd">         the x-axis is assumed to be an isotope shift such that the slope corresponds to</span>
<span class="sd">         a field-shift ratio F(y_i) / F(x).</span>
<span class="sd">        :param sigma2d: Whether to draw the actual two-dimensional uncertainty bounds or the classical errorbars.</span>
<span class="sd">         The integer number corresponds to the number of drawn sigma regions.</span>
<span class="sd">        :param scale: Factors to scale the x and the y-axis.</span>
<span class="sd">        :param add_xy: Additional x and y data to plot. Must have shape (n - 1, k, 5),</span>
<span class="sd">         where n is the dimension of the data vectors, k is the number of additional data points and the five entries</span>
<span class="sd">         in the last axis correspond to arrays of the form [x, x_d, y, y_d, corr_xy].</span>
<span class="sd">        :param add_a: Additional mass numbers for the additional data. Must have shape (k, 2),</span>
<span class="sd">         where each row is a tuple [A, A_ref].</span>
<span class="sd">        :param font_dict: The font_dict passed to matplotlib.rc(&#39;font&#39;, font_dict).</span>
<span class="sd">        :param show: Whether to show the plot.</span>
<span class="sd">        :returns: None. Generates a King-Plot based on the modified axes &#39;self.x_mod_nd&#39; and &#39;self.y_mod_nd&#39;</span>
<span class="sd">         as well as the fit results &#39;self.results_nd&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">font_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">font_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">font_dict</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;family&#39;</span><span class="p">:</span> <span class="s1">&#39;arial&#39;</span><span class="p">},</span> <span class="o">**</span><span class="n">font_dict</span><span class="p">}</span>
        <span class="n">matplotlib</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">font_dict</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">popt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;There are no results yet. Please use one of the fitting options.&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">nd</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_2d</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">sigma2d</span><span class="o">=</span><span class="n">sigma2d</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">add_xy</span><span class="o">=</span><span class="n">add_xy</span><span class="p">,</span> <span class="n">add_a</span><span class="o">=</span><span class="n">add_a</span><span class="p">,</span>
                                 <span class="n">show</span><span class="o">=</span><span class="n">show</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        
        <span class="n">dim</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">popt</span><span class="o">.</span><span class="n">size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">popt</span><span class="p">[:</span><span class="n">dim</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">popt</span><span class="p">[</span><span class="n">dim</span><span class="p">:]</span>
        <span class="n">sigma_a</span><span class="p">,</span> <span class="n">sigma_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pcov</span><span class="p">)[:</span><span class="n">dim</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pcov</span><span class="p">)[</span><span class="n">dim</span><span class="p">:])</span>

        <span class="n">scale_x</span> <span class="o">=</span> <span class="mf">1e-3</span> <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">scale_y</span> <span class="o">=</span> <span class="mf">1e-3</span> <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">offset_str</span> <span class="o">=</span> <span class="s1">&#39; - </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">scale_x</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;x</span><span class="si">{}</span><span class="s1"> (mode=</span><span class="se">\&#39;</span><span class="s1">shifts</span><span class="se">\&#39;</span><span class="s1"> or =</span><span class="se">\&#39;</span><span class="s1">radii</span><span class="se">\&#39;</span><span class="s1"> for right x-label)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">offset_str</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;radii&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">scale_x</span> <span class="o">=</span> <span class="mf">1.</span>
            <span class="n">offset_str</span> <span class="o">=</span> <span class="s1">&#39; - </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">scale_x</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="n">xlabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\mu\,\delta\langle r^2\rangle^{A, A^\prime}&#39;</span> <span class="o">+</span> <span class="n">offset_str</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\quad(\mathrm</span><span class="si">{u}</span><span class="s1">\,\mathrm</span><span class="si">{fm}</span><span class="s1">^2)$&#39;</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;shifts&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">scale_x</span> <span class="o">=</span> <span class="mf">1e-3</span>
            <span class="n">offset_str</span> <span class="o">=</span> <span class="s1">&#39; - </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">scale_x</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="n">xlabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\mu\,\delta\nu_x^{A, A^\prime}&#39;</span> <span class="o">+</span> <span class="n">offset_str</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\quad(\mathrm{u\,GHz})$&#39;</span>

        <span class="n">n_plots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_mod</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">n_cols</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n_plots</span><span class="p">)))</span>
        <span class="n">n_rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_plots</span> <span class="o">/</span> <span class="n">n_cols</span><span class="p">))</span>
        <span class="n">plot_indexes</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_plots</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">iy</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plot_indexes</span><span class="p">):</span>
            <span class="c1"># i_col = i % n_cols</span>
            <span class="c1"># i_row = i // n_cols</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">sigma2d</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x_mod</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_x</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">x_mod</span><span class="p">[:,</span> <span class="n">iy</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale_y</span><span class="p">,</span> <span class="s1">&#39;k.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data&#39;</span><span class="p">)</span>
                <span class="n">draw_sigma2d</span><span class="p">(</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_mod</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_mod</span><span class="p">[:,</span> <span class="n">iy</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale_y</span><span class="p">,</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">])</span> <span class="o">*</span> <span class="n">scale_x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov</span><span class="p">[:,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iy</span><span class="p">])</span> <span class="o">*</span> <span class="n">scale_y</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cov</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">,</span> <span class="n">iy</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov</span><span class="p">[:,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iy</span><span class="p">]),</span>
                    <span class="n">n</span><span class="o">=</span><span class="n">sigma2d</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">add_xy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="n">add_xy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_x</span><span class="p">,</span>
                             <span class="n">add_xy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale_y</span><span class="p">,</span> <span class="s1">&#39;r.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data&#39;</span><span class="p">)</span>
                    <span class="n">draw_sigma2d</span><span class="p">((</span><span class="n">add_xy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_x</span><span class="p">,</span> <span class="n">add_xy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale_y</span><span class="p">,</span>
                                 <span class="n">add_xy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale_x</span><span class="p">,</span> <span class="n">add_xy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale_y</span><span class="p">,</span> <span class="n">add_xy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">4</span><span class="p">],</span>
                                 <span class="n">n</span><span class="o">=</span><span class="n">sigma2d</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s1">&#39;fmt&#39;</span><span class="p">:</span> <span class="s1">&#39;-r&#39;</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x_mod</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_mod</span><span class="p">[:,</span> <span class="n">iy</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale_y</span><span class="p">,</span>
                             <span class="n">xerr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">])</span> <span class="o">*</span> <span class="n">scale_x</span><span class="p">,</span>
                             <span class="n">yerr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov</span><span class="p">[:,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iy</span><span class="p">])</span> <span class="o">*</span> <span class="n">scale_y</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;k.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_fit</span><span class="p">)):</span>
                <span class="n">pm</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span> <span class="k">if</span> <span class="n">b</span><span class="p">[</span><span class="n">iy</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">1.</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x_mod</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">])</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span>
                         <span class="o">*</span> <span class="n">scale_x</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_mod</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">pm</span> <span class="o">*</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iy</span><span class="p">]))</span> <span class="o">*</span> <span class="n">scale_y</span><span class="p">,</span>
                         <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> - </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_fit</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_ref</span><span class="p">[</span><span class="n">j</span><span class="p">]),</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span> <span class="k">if</span> <span class="n">b</span><span class="p">[</span><span class="n">iy</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;bottom&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">add_a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">add_xy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">add_xy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">pm</span> <span class="o">=</span> <span class="mf">1.</span> <span class="k">if</span> <span class="n">b</span><span class="p">[</span><span class="n">iy</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mf">1.</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="n">add_xy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">add_xy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_x</span><span class="p">,</span>
                             <span class="p">(</span><span class="n">add_xy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">pm</span> <span class="o">*</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">add_xy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="n">scale_y</span><span class="p">,</span>
                             <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> - </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">add_a</span><span class="p">[</span><span class="n">j</span><span class="p">]),</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span> <span class="k">if</span> <span class="n">b</span><span class="p">[</span><span class="n">iy</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;top&#39;</span><span class="p">)</span>

            <span class="n">min_x</span><span class="p">,</span> <span class="n">max_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_mod</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_mod</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">add_xy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">min_x</span><span class="p">,</span> <span class="n">max_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">min_x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">add_xy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">])]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">max_x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">add_xy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">])])</span>

            <span class="n">x_cont</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">min_x</span> <span class="o">-</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span><span class="p">),</span> <span class="n">max_x</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span><span class="p">),</span> <span class="mi">1001</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_cont</span> <span class="o">*</span> <span class="n">scale_x</span><span class="p">,</span> <span class="n">straight</span><span class="p">(</span><span class="n">x_cont</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="n">iy</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">iy</span><span class="p">])</span> <span class="o">*</span> <span class="n">scale_y</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Fit&#39;</span><span class="p">)</span>

            <span class="n">corr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcov</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">dim</span> <span class="o">+</span> <span class="n">iy</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma_a</span><span class="p">[</span><span class="n">iy</span><span class="p">]</span> <span class="o">*</span> <span class="n">sigma_b</span><span class="p">[</span><span class="n">iy</span><span class="p">])</span>
            <span class="n">y_min</span> <span class="o">=</span> <span class="n">straight</span><span class="p">(</span><span class="n">x_cont</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="n">iy</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">iy</span><span class="p">])</span> <span class="o">-</span> <span class="n">straight_std</span><span class="p">(</span><span class="n">x_cont</span><span class="p">,</span> <span class="n">sigma_a</span><span class="p">[</span><span class="n">iy</span><span class="p">],</span> <span class="n">sigma_b</span><span class="p">[</span><span class="n">iy</span><span class="p">],</span> <span class="n">corr</span><span class="p">)</span>
            <span class="n">y_max</span> <span class="o">=</span> <span class="n">straight</span><span class="p">(</span><span class="n">x_cont</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="n">iy</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">iy</span><span class="p">])</span> <span class="o">+</span> <span class="n">straight_std</span><span class="p">(</span><span class="n">x_cont</span><span class="p">,</span> <span class="n">sigma_a</span><span class="p">[</span><span class="n">iy</span><span class="p">],</span> <span class="n">sigma_b</span><span class="p">[</span><span class="n">iy</span><span class="p">],</span> <span class="n">corr</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x_cont</span> <span class="o">*</span> <span class="n">scale_x</span><span class="p">,</span> <span class="n">y_min</span> <span class="o">*</span> <span class="n">scale_y</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">*</span> <span class="n">scale_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">antialiased</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\mu\,\delta\nu_{y&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;}^{A, A^\prime}\quad(\mathrm{u\,GHz})$&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">numpoints</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="c1"># plt.tight_layout()</span>
            <span class="c1"># plt.subplots_adjust(left=0.2, bottom=0.1, right=0.9, top=0.9, wspace=0.5, hspace=0.4)</span>
        
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Patrick Mueller.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>